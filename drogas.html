<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - Drogas Apreendidas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styledrogas.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* Ajuste para garantir que a tabela ocupe o espaço correto sem quebrar o design */
        .tabela-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        #tabela-drogas input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .btn-action {
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
        }

        .btn-editar {
            background-color: #f0ad4e;
            color: white;
        }

        .btn-salvar {
            background-color: #5cb85c;
            color: white;
        }

        .btn-cancelar {
            background-color: #d9534f;
            color: white;
        }

        .btn-excluir {
            background-color: #333;
            color: white;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>
        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info"></div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a>
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a>
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a>
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a>
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a>
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button>
        </nav>

        <main>
            <div class="saudacao">
                <h2>Gerenciamento de Registros de Drogas Apreendidas</h2>
                <h4>Cards atualizados com totais do ano corrente por tipo.</h4>
            </div>

            <section class="totalcards">
                <div class="cardnumero" id="iconmaconha">
                    <h3>Maconha</h3>
                    <p id="total-maconha" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcrack">
                    <h3>Crack</h3>
                    <p id="total-crack" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcocaina">
                    <h3>Cocaína</h3>
                    <p id="total-cocaina" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconrufinol">
                    <h3>Rufinol</h3>
                    <p id="total-rufinol" class="numero-grande">0 Un</p>
                </div>
                <div class="cardnumero" id="iconlolo">
                    <h3>Loló</h3>
                    <p id="total-lolo" class="numero-grande">0 Un</p>
                </div>
            </section>

            <div class="TabelaEventos">
                <h3>Tabela de Registros</h3>
                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png" alt="Add" />
                        Adicionar Novo Registro
                    </button>
                    <p id="mensagem-carregamento">Carregando dados...</p>
                </div>

                <div class="filtros-container">
                    <label>Pesquisa Rápida:</label>
                    <input type="text" id="filtro-global" placeholder="Digite para filtrar..."
                        onkeyup="filtrarTabela()">
                    <button class="btn-secondary" onclick="window.print()">Imprimir</button>
                </div>

                <div class="tabela-container">
                    <table id="tabela-drogas">
                        <thead>
                            <tr id="table-header-row">
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>

    <footer>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </footer>

    <script>
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        let allDrogas = [];

        const HEADERS = [
            'ID', 'DATA', 'NUMERO COP', 'FATO TÍPICO', 'NOME', 'RG', 'CPF', 'IDADE',
            'ALCUNHA', 'SEXO', 'MÃE', 'CIDADE', 'ESTADO', 'BAIRRO', 'PONTO REF',
            'ENDEREÇO', 'DIA', 'MÊS', 'HORA', 'LATITUDE', 'LONGITUDE', 'TIPO DE DROGA',
            'PESO (Kg)', 'DADOS DA EQUIPE', 'NUMERO_LACRE', 'MOVIMENTAÇÃO'
        ];

        // 1. CARREGAMENTO INICIAL
        async function loadDrogas() {
            const msg = document.getElementById('mensagem-carregamento');
            try {
                const response = await fetch(`${WEBAPP_URL}?action=read`);
                const data = await response.json();
                allDrogas = data;
                renderTable(allDrogas);
                atualizarDrogasPorTipo();
                msg.style.display = 'none';
            } catch (e) {
                msg.textContent = "Erro ao carregar dados.";
            }
        }

        // 2. RENDERIZAÇÃO DA TABELA (Mantendo Design Padrão)
        function renderTable(data) {
            const thead = document.getElementById('table-header-row');
            const tbody = document.querySelector('#tabela-drogas tbody');

            thead.innerHTML = HEADERS.map(h => `<th>${h}</th>`).join('') + '<th>AÇÕES</th>';
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = tbody.insertRow();
                HEADERS.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = item[header] || '';
                    cell.dataset.header = header;
                });

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="btn-action btn-editar" onclick="editRow(this)">Editar</button>
                    <button class="btn-action btn-excluir" onclick="deleteRow('${item.ID}')">Excluir</button>
                `;
            });
        }

        // 3. PESQUISA RÁPIDA (Filtro Manual para não quebrar design)
        function filtrarTabela() {
            const termo = document.getElementById('filtro-global').value.toUpperCase();
            const filtrados = allDrogas.filter(d =>
                Object.values(d).some(v => String(v).toUpperCase().includes(termo))
            );
            renderTable(filtrados);
        }

        // 4. EDIÇÃO NA LINHA
        function editRow(btn) {
            const row = btn.closest('tr');
            const cells = row.querySelectorAll('td');

            // Transformar células em inputs (exceto ID e Ações)
            for (let i = 1; i < cells.length - 1; i++) {
                const currentVal = cells[i].textContent;
                cells[i].innerHTML = `<input type="text" value="${currentVal}">`;
            }

            const actionsCell = cells[cells.length - 1];
            actionsCell.innerHTML = `
                <button class="btn-action btn-salvar" onclick="saveRow(this)">Salvar</button>
                <button class="btn-action btn-cancelar" onclick="loadDrogas()">Cancelar</button>
            `;
        }

        async function saveRow(btn) {
            const row = btn.closest('tr');
            const id = row.cells[0].textContent;
            const updatedData = { action: 'update', ID: id };

            HEADERS.slice(1).forEach((header, index) => {
                const input = row.cells[index + 1].querySelector('input');
                if (input) updatedData[header] = input.value;
            });

            // Lógica de envio (fetch POST para o seu Google Script)
            // Aqui você deve usar o seu código de fetch/saveRecord original
            console.log("Enviando atualização:", updatedData);
            alert("Enviando dados para a planilha...");
            // Após sucesso: loadDrogas();
        }

        // 5. TOTAIS DOS CARDS (Sua lógica de API mantida)
        async function atualizarDrogasPorTipo() {
            const tipos = ['MACONHA', 'CRACK', 'COCAINA', 'RUFINOL', 'LOLÓ'];
            const anoAtual = new Date().getFullYear();

            try {
                const response = await fetch(`${WEBAPP_URL}?action=sumPesoByDrugTypeAndYear&year=${anoAtual}`);
                const data = await response.json();

                if (data.totals) {
                    tipos.forEach(tipo => {
                        const el = document.getElementById(`total-${tipo.toLowerCase().replace('ó', 'o').replace('í', 'i')}`);
                        if (el) {
                            const un = (tipo === 'RUFINOL' || tipo === 'LOLÓ') ? 'Un' : 'Kg';
                            el.textContent = `${data.totals[tipo] || '0,0000'} ${un}`;
                        }
                    });
                }
            } catch (e) { console.error("Erro nos cards:", e); }
        }

        // 6. UTILITÁRIOS (Relógio, Login, Logout)
        function atualizarRelogio() {
            const agora = new Date();
            document.getElementById('relogio').innerHTML = agora.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' }) + '<br>' + agora.toLocaleTimeString('pt-BR');
        }

        function checkLogin() {
            const grad = localStorage.getItem('userGraduacao');
            const nome = localStorage.getItem('userNomeGuerra');
            if (!grad) window.location.href = 'login.html';
            else document.getElementById('user-info').innerHTML = `<p>Bem Vindo:</p><p class="user-nome">${grad} ${nome}</p>`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            loadDrogas();

            document.getElementById('btn-logout').onclick = () => {
                localStorage.clear();
                window.location.href = 'login.html';
            };
        });
    </script>
</body>

</html>