<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - Drogas Apreendidas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styledrogas.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* Ajuste para garantir que a tabela ocupe o espaço correto sem quebrar o design */
        .tabela-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        #tabela-drogas input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .btn-action {
            padding: 5px 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
        }

        .btn-editar {
            background-color: #f0ad4e;
            color: white;
        }

        .btn-salvar {
            background-color: #5cb85c;
            color: white;
        }

        .btn-cancelar {
            background-color: #d9534f;
            color: white;
        }

        .btn-excluir {
            background-color: #333;
            color: white;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>
        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info"></div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->

        <main>
            <div class="saudacao">
                <h2>Gerenciamento de Registros de Drogas Apreendidas</h2>
                <h4>Cards atualizados com totais do ano corrente por tipo.</h4>
            </div>

            <section class="totalcards">
                <div class="cardnumero" id="iconmaconha">
                    <h3>Maconha</h3>
                    <p id="total-maconha" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcrack">
                    <h3>Crack</h3>
                    <p id="total-crack" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcocaina">
                    <h3>Cocaína</h3>
                    <p id="total-cocaina" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconrufinol">
                    <h3>Rufinol</h3>
                    <p id="total-rufinol" class="numero-grande">0 Un</p>
                </div>
                <div class="cardnumero" id="iconlolo">
                    <h3>Loló</h3>
                    <p id="total-lolo" class="numero-grande">0 Un</p>
                </div>
            </section>

            <div class="TabelaEventos">
                <h3>Tabela de Registros</h3>
                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png" alt="Add" />
                        Adicionar Novo Registro
                    </button>
                    <p id="mensagem-carregamento">Carregando dados...</p>
                </div>

                <div class="filtros-container">
                    <label>Pesquisa Rápida:</label>
                    <input type="text" id="filtro-global" placeholder="Digite para filtrar..."
                        onkeyup="filtrarTabela()">
                    <button class="btn-secondary" onclick="window.print()">Imprimir</button>
                </div>

                <div class="tabela-container">
                    <table id="tabela-drogas">
                        <thead>
                            <tr id="table-header-row">
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div><!--termina TabelaEventos-->

            <div id="overlay-sidebar" class="overlay-sidebar"></div>

            <form class="sidbarform" id="form-drogas">
                <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
                <h4>Cadastro de Drogas</h4>

                <input type="hidden" id="form-id" name="ID">

                <div class="formulario-scroll">
                    <div class="formulario">
                        <p>DATA/p>
                            <input type="date" name="DATA" id="data">
                    </div>
                    <div class="formulario">
                        <p>NÚMERO COP</p>
                        <input type="text" name="NUMERO COP" id="numero-cop">
                    </div>
                    <div class="formulario">
                        <p>FATO TÍPICO</p>
                        <select name="fatotipico" id="fatotipico">
                            <option value="TRÁFICO DE DROGAS">TRÁFICO DE DROGAS</option>
                            <option value="POSSE DE DROGAS PARA CONSUMO">POSSE DE DROGAS PARA CONSUMO</option>
                            <option value="CUMPRIMENTO DE MANDADO">CUMPRIMENTO DE MANDADO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>NOME</p>
                        <input type="text" name="NOME" id="nome">
                    </div>
                    <div class="formulario">
                        <p>RG</p>
                        <input type="text" name="RG" id="rg">
                    </div>
                    <div class="formulario">
                        <p>CPF</p>
                        <input type="text" name="CPF" id="cpf">
                    </div>
                    <div class="formulario">
                        <p>IDADE</p>
                        <input type="number" name="IDADE" id="idade">
                    </div>
                    <div class="formulario">
                        <p>ALCUNHA</p>
                        <input type="text" name="ALCUNHA" id="alcunha">
                    </div>
                    <div class="formulario">
                        <p>SEXO</p>
                        <select name="SEXO" id="sexo">
                            <option value="MASCULINO">MASCULINO</option>
                            <option value="FEMININO">FEMININO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>MÃE</p>
                        <input type="text" name="MÃE" id="mae">
                    </div>
                    <div class="formulario">
                        <p>CIDADE</p>
                        <select name="CIDADE" id="cidade">
                        <option value="BELÉM">BELÉM</option>
                        <option value="CACIMBINHAS">CACIMBINHAS</option>
                        <option value="ESTRELA DE ALAGOAS">ESTRELA DE ALAGOAS</option>
                        <option value="IGACI">IGACI</option>
                        <option value="MAR VERMELHO">MAR VERMELHO</option>
                        <option value="MARIBONDO">MARIBONDO</option>
                        <option value="MINADOR DO NEGRÃO">MINADOR DO NEGRÃO</option>
                        <option value="PAULO JACINTO">PAULO JACINTO</option>
                        <option value="PALMEIRA DOS ÍNDIOS">PALMEIRA DOS ÍNDIOS</option>
                        <option value="QUEBRANGULO">QUEBRANGULO</option>
                        <option value="TANQUE D'ARCA">TANQUE D'ARCA</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>ESTADO</p>
                        <input type="text" name="ESTADO" id="estado" value="ALAGOAS">
                    </div>
                    <div class="formulario">
                        <p>BAIRRO</p>
                        <input type="text" name="BAIRRO" id="bairro">
                    </div>
                    <div class="formulario">
                        <p>PONTO REF</p>
                        <input type="text" name="PONTO REF" id="ponto-ref">
                    </div>
                    <div class="formulario">
                        <p>ENDEREÇO</p>
                        <input type="text" name="ENDEREÇO" id="endereco">
                    </div>
                    <div class="formulario">
                        <p>MÊS</p>
                        <select name="MÊS" id="mes">
                            <option value="JANEIRO">JANEIRO</option>
                            <option value="FEVEREIRO">FEVEREIRO</option>
                            <option value="MARÇO">MARÇO</option>
                            <option value="ABRIL">ABRIL</option>
                            <option value="MAIO">MAIO</option>
                            <option value="JUNHO">JUNHO</option>
                            <option value="JULHO">JULHO</option>
                            <option value="AGOSTO">AGOSTO</option>
                            <option value="SETEMBRO">SETEMBRO</option>
                            <option value="OUTUBRO">OUTUBRO</option>
                            <option value="NOVEMBRO">NOVEMBRO</option>
                            <option value="DEZEMBRO">DEZEMBRO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>HORA</p>
                        <input type="time" name="HORA" id="hora">
                    </div>
                    <div class="formulario">
                        <p>LATITUDE,LONGITUDE</p>
                        <input type="text" name="LATITUDE" id="latitude">
                    </div>
                    <div class="formulario">
                        <p>TIPO DE DROGA</p>
                        <select name="TIPO DE DROGA" id="tipo-droga">
                            <option value="MACONHA">MACONHA</option>
                            <option value="CRACK">CRACK</option>
                            <option value="COCAINA">COCAÍNA</option>
                            <option value="RUFINOL">RUFINOL</option>
                            <option value="LOLÓ">LOLÓ</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>PESO (Kg)</p>
                        <input type="number" step="0.0001" name="PESO (Kg)" id="peso">
                    </div>
                    <div class="formulario">
                        <p>DADOS DA EQUIPE</p>
                        <input type="text" name="DADOS DA EQUIPE" id="dados-equipe">
                    </div>
                    <div class="formulario">
                        <p>NUMERO_LACRE</p>
                        <input type="text" name="NUMERO_LACRE" id="numero-lacre">
                    </div>
                    <div class="formulario">
                        <p>MOVIMENTAÇÃO</p>
                        <input type="text" name="MOVIMENTAÇÃO" id="movimentacao">
                    </div>
                </div><!--termina formulario-scroll-->

                <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                    style="width: 100%; padding: 15px; margin-top: 20px;">
                    SALVAR DADOS
                </button>
            </form><!--termina sidebarform-->

        </main>


    </section>

    <footer>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </footer>

    <script>
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        let allDrogas = [];

        const HEADERS = [
            'ID', 'DATA', 'NUMERO COP', 'FATO TÍPICO', 'NOME', 'RG', 'CPF', 'IDADE',
            'ALCUNHA', 'SEXO', 'MÃE', 'CIDADE', 'ESTADO', 'BAIRRO', 'PONTO REF',
            'ENDEREÇO', 'DIA', 'MÊS', 'HORA', 'LATITUDE', 'LONGITUDE', 'TIPO DE DROGA',
            'PESO (Kg)', 'DADOS DA EQUIPE', 'NUMERO_LACRE', 'MOVIMENTAÇÃO'
        ];

        // Elementos da Sidebar (Certifique-se que esses IDs existam no seu HTML)
        const sidebar = document.getElementById('form-drogas');
        const overlay = document.getElementById('overlay-sidebar');

        /**
         * FUNÇÃO DA SIDEBAR (SLIDE)
         */
        function toggleSidebar(show = true, data = null) {
            if (!sidebar) return;

            if (show) {
                sidebar.reset(); // Limpa o form
                document.getElementById('form-id').value = ''; // Limpa ID oculto

                if (data) {
                    // Preenche os campos da sidebar com os dados da linha (Edição)
                    document.getElementById('form-id').value = data['ID'] || '';
                    document.getElementById('data').value = data['DATA'] || '';
                    document.getElementById('cidade').value = data['CIDADE'] || '';
                    // Adicione aqui os demais campos conforme os IDs do seu form
                }
                sidebar.classList.add('active');
                if (overlay) overlay.classList.add('active');
            } else {
                sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
            }
        }

        // 1. CARREGAMENTO INICIAL
        async function loadDrogas() {
            const msg = document.getElementById('mensagem-carregamento');
            try {
                const response = await fetch(`${WEBAPP_URL}?action=read`);
                const data = await response.json();
                allDrogas = data;
                renderTable(allDrogas);
                atualizarDrogasPorTipo();
                if (msg) msg.style.display = 'none';
            } catch (e) {
                if (msg) msg.textContent = "Erro ao carregar dados.";
            }
        }

        // 2. RENDERIZAÇÃO DA TABELA (Mantendo seu design)
        function renderTable(data) {
            const thead = document.getElementById('table-header-row');
            const tbody = document.querySelector('#tabela-drogas tbody');

            if (thead) thead.innerHTML = HEADERS.map(h => `<th>${h}</th>`).join('') + '<th>AÇÕES</th>';
            if (!tbody) return;
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = tbody.insertRow();
                HEADERS.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = item[header] || '';
                    cell.dataset.header = header;
                });

                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                <button class="btn-action btn-editar" style="background:#2c3e50; color:white;">Editar</button>
            `;
                // Ao clicar em editar, abre a SIDEBAR em vez de editar na linha
                actionsCell.querySelector('.btn-editar').onclick = () => toggleSidebar(true, item);
            });
        }

        // 3. PESQUISA RÁPIDA
        function filtrarTabela() {
            const termo = document.getElementById('filtro-global').value.toUpperCase();
            const filtrados = allDrogas.filter(d =>
                Object.values(d).some(v => String(v).toUpperCase().includes(termo))
            );
            renderTable(filtrados);
        }

        // 4. ENVIO DOS DADOS (POST)
        async function salvarDados(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar-form');
            btn.disabled = true;
            btn.textContent = "Gravando...";

            const formData = new FormData(sidebar);
            const payload = Object.fromEntries(formData.entries());
            payload.action = payload.ID ? 'update' : 'create';

            try {
                // Envio para o Google Apps Script
                await fetch(WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Para evitar erro de redirecionamento do Google
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(payload)
                });

                alert("Dados enviados com sucesso!");
                toggleSidebar(false);
                setTimeout(loadDrogas, 1500); // Recarrega a tabela após um delay
            } catch (err) {
                alert("Erro ao salvar.");
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = "SALVAR DADOS";
            }
        }

        // 5. TOTAIS DOS CARDS (Sua lógica mantida)
        async function atualizarDrogasPorTipo() {
            const tipos = ['MACONHA', 'CRACK', 'COCAINA', 'RUFINOL', 'LOLÓ'];
            const anoAtual = new Date().getFullYear();

            try {
                const response = await fetch(`${WEBAPP_URL}?action=sumPesoByDrugTypeAndYear&year=${anoAtual}`);
                const data = await response.json();

                if (data.totals) {
                    tipos.forEach(tipo => {
                        const el = document.getElementById(`total-${tipo.toLowerCase().replace('ó', 'o').replace('í', 'i')}`);
                        if (el) {
                            const un = (tipo === 'RUFINOL' || tipo === 'LOLÓ') ? 'Un' : 'Kg';
                            el.textContent = `${data.totals[tipo] || '0,0000'} ${un}`;
                        }
                    });
                }
            } catch (e) { console.error("Erro nos cards:", e); }
        }

        // 6. UTILITÁRIOS (Relógio, Login, Logout)
        function atualizarRelogio() {
            const agora = new Date();
            const relogioEl = document.getElementById('relogio');
            if (relogioEl) {
                relogioEl.innerHTML = agora.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' }) + '<br>' + agora.toLocaleTimeString('pt-BR');
            }
        }

        function checkLogin() {
            const grad = localStorage.getItem('userGraduacao');
            const nome = localStorage.getItem('userNomeGuerra');
            const userEl = document.getElementById('user-info');
            if (!grad) {
                window.location.href = 'login.html';
            } else if (userEl) {
                userEl.innerHTML = `<p>Bem Vindo:</p><p class="user-nome">${grad} ${nome}</p>`;
            }
        }

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            loadDrogas();

            // Listeners
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) btnLogout.onclick = () => {
                localStorage.clear();
                window.location.href = 'login.html';
            };

            const btnAdd = document.getElementById('btn-adicionar-cadastro');
            if (btnAdd) btnAdd.onclick = () => toggleSidebar(true);

            const btnFechar = document.getElementById('btn-fechar-sidebar');
            if (btnFechar) btnFechar.onclick = () => toggleSidebar(false);

            if (overlay) overlay.onclick = () => toggleSidebar(false);

            // Listener do Form
            if (sidebar) sidebar.onsubmit = salvarDados;
        });
    </script>
</body>

</html>