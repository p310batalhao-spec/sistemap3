<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - Drogas Apreendidas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styledrogas.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>
        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info"></div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->

        <main>
            <div class="saudacao">
                <h2>Gerenciamento de Registros de Drogas Apreendidas</h2>
                <h4>Cards atualizados com totais do ano corrente por tipo.</h4>
            </div>

            <section class="totalcards">
                <div class="cardnumero" id="iconmaconha">
                    <h3>Maconha</h3>
                    <p id="total-maconha" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcrack">
                    <h3>Crack</h3>
                    <p id="total-crack" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconcocaina">
                    <h3>Cocaína</h3>
                    <p id="total-cocaina" class="numero-grande">0 Kg</p>
                </div>
                <div class="cardnumero" id="iconrufinol">
                    <h3>Rufinol</h3>
                    <p id="total-rufinol" class="numero-grande">0 Un</p>
                </div>
                <div class="cardnumero" id="iconlolo">
                    <h3>Loló</h3>
                    <p id="total-lolo" class="numero-grande">0 Un</p>
                </div>
            </section>

            <div class="TabelaEventos">
                <h3>Tabela de Registros</h3>

                <div class="adicionar-cadastro-container"
                    style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png" alt="Add" />
                        Adicionar Novo Registro
                    </button>

                    <button id="btn-abrir-filtro-relatorio"
                        style="background-color: #1a3d5d; color: white; display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/print.png"
                            style="filter: invert(1);" alt="Print" />
                        Gerar Relatório Profissional
                    </button>

                    <p id="mensagem-carregamento">Carregando dados...</p>
                </div>

                <div id="modal-filtro-relatorio" class="modal-relatorio"
                    style="display:none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);">
                    <div
                        style="background: white; width: 350px; margin: 10% auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h3 style="margin-top: 0; color: #1a3d5d;">Parâmetros do Relatório</h3>
                        <label style="display:block; margin-top:10px;">Data Início:</label>
                        <input type="date" id="rel-inicio"
                            style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">

                        <label style="display:block;">Data Fim:</label>
                        <input type="date" id="rel-fim"
                            style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">

                        <label style="display:block;">Tipo de Droga:</label>
                        <select id="rel-tipo"
                            style="width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="TODOS">TODOS</option>
                            <option value="TRÁFICO DE DROGAS">TRÁFICO DE DROGAS</option>
                            <option value="POSSE DE DROGAS PARA CONSUMO">POSSE DE DROGAS PARA CONSUMO</option>
                            <option value="CUMPRIMENTO DE MANDADO">CUMPRIMENTO DE MANDADO</option>
                        </select>

                        <button onclick="gerarRelatorio()"
                            style="width: 100%; background: #28a745; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">GERAR
                            RELATÓRIO</button>
                        <button onclick="document.getElementById('modal-filtro-relatorio').style.display='none'"
                            style="width: 100%; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; margin-top: 5px;">CANCELAR</button>
                    </div>
                </div>

                <div id="modal-relatorio" class="modal-relatorio"
                    style="display:none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);">
                    <div class="modal-content"
                        style="width: 95%; height: 95%; margin: 1% auto; background: white; position: relative;">
                        <button onclick="fecharModalRelatorio()" class="btn-cancelar"
                            style="position: absolute; right: 10px; top: 10px; z-index: 10001;">FECHAR X</button>
                        <iframe id="iframe-relatorio" src="" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>

                <div class="filtros-container">
                    <label>Pesquisa Rápida na Tabela:</label>
                    <input type="text" id="filtro-global" placeholder="Digite para filtrar..."
                        onkeyup="filtrarTabela()">
                </div>

                <div class="tabela-container">
                    <table id="tabela-drogas">
                        <thead>
                            <tr id="table-header-row"></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="overlay-sidebar" class="overlay-sidebar"></div>

            <form class="sidbarform" id="form-drogas">
                <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
                <h4>Cadastro de Drogas</h4>

                <input type="hidden" id="form-id" name="ID">

                <div class="formulario-scroll">
                    <div class="formulario">
                        <p>DATA/p>
                            <input type="date" name="DATA" id="data">
                    </div>
                    <div class="formulario">
                        <p>NÚMERO COP</p>
                        <input type="text" name="NUMERO COP" id="numero-cop">
                    </div>
                    <div class="formulario">
                        <p>FATO TÍPICO</p>
                        <select name="fatotipico" id="fatotipico">
                            <option value="TRÁFICO DE DROGAS">TRÁFICO DE DROGAS</option>
                            <option value="POSSE DE DROGAS PARA CONSUMO">POSSE DE DROGAS PARA CONSUMO</option>
                            <option value="CUMPRIMENTO DE MANDADO">CUMPRIMENTO DE MANDADO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>NOME</p>
                        <input type="text" name="NOME" id="nome">
                    </div>
                    <div class="formulario">
                        <p>RG</p>
                        <input type="text" name="RG" id="rg">
                    </div>
                    <div class="formulario">
                        <p>CPF</p>
                        <input type="text" name="CPF" id="cpf">
                    </div>
                    <div class="formulario">
                        <p>IDADE</p>
                        <input type="number" name="IDADE" id="idade">
                    </div>
                    <div class="formulario">
                        <p>ALCUNHA</p>
                        <input type="text" name="ALCUNHA" id="alcunha">
                    </div>
                    <div class="formulario">
                        <p>SEXO</p>
                        <select name="SEXO" id="sexo">
                            <option value="MASCULINO">MASCULINO</option>
                            <option value="FEMININO">FEMININO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>MÃE</p>
                        <input type="text" name="MÃE" id="mae">
                    </div>
                    <div class="formulario">
                        <p>CIDADE</p>
                        <select name="CIDADE" id="cidade">
                            <option value="BELÉM">BELÉM</option>
                            <option value="CACIMBINHAS">CACIMBINHAS</option>
                            <option value="ESTRELA DE ALAGOAS">ESTRELA DE ALAGOAS</option>
                            <option value="IGACI">IGACI</option>
                            <option value="MAR VERMELHO">MAR VERMELHO</option>
                            <option value="MARIBONDO">MARIBONDO</option>
                            <option value="MINADOR DO NEGRÃO">MINADOR DO NEGRÃO</option>
                            <option value="PAULO JACINTO">PAULO JACINTO</option>
                            <option value="PALMEIRA DOS ÍNDIOS">PALMEIRA DOS ÍNDIOS</option>
                            <option value="QUEBRANGULO">QUEBRANGULO</option>
                            <option value="TANQUE D'ARCA">TANQUE D'ARCA</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>ESTADO</p>
                        <input type="text" name="ESTADO" id="estado" value="ALAGOAS">
                    </div>
                    <div class="formulario">
                        <p>BAIRRO</p>
                        <input type="text" name="BAIRRO" id="bairro">
                    </div>
                    <div class="formulario">
                        <p>PONTO REF</p>
                        <input type="text" name="PONTO REF" id="ponto-ref">
                    </div>
                    <div class="formulario">
                        <p>ENDEREÇO</p>
                        <input type="text" name="ENDEREÇO" id="endereco">
                    </div>
                    <div class="formulario">
                        <p>MÊS</p>
                        <select name="MÊS" id="mes">
                            <option value="JANEIRO">JANEIRO</option>
                            <option value="FEVEREIRO">FEVEREIRO</option>
                            <option value="MARÇO">MARÇO</option>
                            <option value="ABRIL">ABRIL</option>
                            <option value="MAIO">MAIO</option>
                            <option value="JUNHO">JUNHO</option>
                            <option value="JULHO">JULHO</option>
                            <option value="AGOSTO">AGOSTO</option>
                            <option value="SETEMBRO">SETEMBRO</option>
                            <option value="OUTUBRO">OUTUBRO</option>
                            <option value="NOVEMBRO">NOVEMBRO</option>
                            <option value="DEZEMBRO">DEZEMBRO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>HORA</p>
                        <input type="time" name="HORA" id="hora">
                    </div>
                    <div class="formulario">
                        <p>LATITUDE,LONGITUDE</p>
                        <input type="text" name="LATITUDE" id="latitude">
                    </div>
                    <div class="formulario">
                        <p>TIPO DE DROGA</p>
                        <select name="TIPO DE DROGA" id="tipo-droga">
                            <option value="MACONHA">MACONHA</option>
                            <option value="CRACK">CRACK</option>
                            <option value="COCAINA">COCAÍNA</option>
                            <option value="RUFINOL">RUFINOL</option>
                            <option value="LOLÓ">LOLÓ</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>PESO (Kg)</p>
                        <input type="number" step="0.0001" name="PESO (Kg)" id="peso">
                    </div>
                    <div class="formulario">
                        <p>DADOS DA EQUIPE</p>
                        <input type="text" name="DADOS DA EQUIPE" id="dados-equipe">
                    </div>
                    <div class="formulario">
                        <p>NUMERO_LACRE</p>
                        <input type="text" name="NUMERO_LACRE" id="numero-lacre">
                    </div>
                    <div class="formulario">
                        <p>MOVIMENTAÇÃO</p>
                        <input type="text" name="MOVIMENTAÇÃO" id="movimentacao">
                    </div>
                </div><!--termina formulario-scroll-->

                <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                    style="width: 100%; padding: 15px; margin-top: 20px;">
                    SALVAR DADOS
                </button>
            </form><!--termina sidebarform-->

        </main>


    </section>

    <footer>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </footer>

    <script>
        // Substitua pela sua URL correta se for diferente
        const API_URL = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        const WEBAPP_URL = API_URL;

        let allDrogas = [];

        const HEADERS = [
            'ID', 'DATA', 'NUMERO COP', 'FATO TÍPICO', 'NOME', 'RG', 'CPF', 'IDADE',
            'ALCUNHA', 'SEXO', 'MÃE', 'CIDADE', 'ESTADO', 'BAIRRO', 'PONTO REF',
            'ENDEREÇO', 'DIA', 'MÊS', 'HORA', 'LATITUDE', 'LONGITUDE', 'TIPO DE DROGA',
            'PESO (Kg)', 'DADOS DA EQUIPE', 'NUMERO_LACRE', 'MOVIMENTAÇÃO'
        ];

        // Elementos da Sidebar
        const sidebar = document.getElementById('form-drogas');
        const overlay = document.getElementById('overlay-sidebar');

        function toggleSidebar(show = true, data = null) {
            if (!sidebar) return;
            if (show) {
                sidebar.reset();
                document.getElementById('form-id').value = '';
                if (data) {
                    document.getElementById('form-id').value = data['ID'] || '';
                    document.getElementById('data').value = data['DATA'] || '';
                    document.getElementById('cidade').value = data['CIDADE'] || '';
                    // Adicione outros campos se necessário
                }
                sidebar.classList.add('active');
                if (overlay) overlay.classList.add('active');
            } else {
                sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
            }
        }

        async function loadDrogas() {
            const msg = document.getElementById('mensagem-carregamento');
            try {
                const response = await fetch(`${WEBAPP_URL}?action=read`);
                const data = await response.json();
                allDrogas = data;
                renderTable(allDrogas);
                atualizarDrogasPorTipo();
                if (msg) msg.style.display = 'none';
            } catch (e) {
                if (msg) msg.textContent = "Erro ao carregar dados.";
            }
        }

        function renderTable(data) {
            const thead = document.getElementById('table-header-row');
            const tbody = document.querySelector('#tabela-drogas tbody');
            if (thead) thead.innerHTML = HEADERS.map(h => `<th>${h}</th>`).join('') + '<th>AÇÕES</th>';
            if (!tbody) return;
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = tbody.insertRow();
                HEADERS.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = item[header] || '';
                });
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `<button class="btn-action btn-editar" style="background:#2c3e50; color:white;">Editar</button>`;
                actionsCell.querySelector('.btn-editar').onclick = () => toggleSidebar(true, item);
            });
        }

        function filtrarTabela() {
            const termo = document.getElementById('filtro-global').value.toUpperCase();
            const filtrados = allDrogas.filter(d =>
                Object.values(d).some(v => String(v).toUpperCase().includes(termo))
            );
            renderTable(filtrados);
        }

        async function salvarDados(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar-form');
            btn.disabled = true;
            btn.textContent = "Gravando...";
            const formData = new FormData(sidebar);
            const payload = Object.fromEntries(formData.entries());
            payload.action = payload.ID ? 'update' : 'create';
            try {
                await fetch(WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(payload)
                });
                alert("Dados enviados com sucesso!");
                toggleSidebar(false);
                setTimeout(loadDrogas, 1500);
            } catch (err) {
                alert("Erro ao salvar.");
            } finally {
                btn.disabled = false;
                btn.textContent = "SALVAR DADOS";
            }
        }

        async function atualizarDrogasPorTipo() {
            const tipos = ['MACONHA', 'CRACK', 'COCAINA', 'RUFINOL', 'LOLÓ'];
            const anoAtual = new Date().getFullYear();
            try {
                const response = await fetch(`${WEBAPP_URL}?action=sumPesoByDrugTypeAndYear&year=${anoAtual}`);
                const data = await response.json();
                if (data.totals) {
                    tipos.forEach(tipo => {
                        const idElemento = `total-${tipo.toLowerCase().replace('ó', 'o').replace('í', 'i')}`;
                        const el = document.getElementById(idElemento);
                        if (el) {
                            const un = (tipo === 'RUFINOL' || tipo === 'LOLÓ') ? 'Un' : 'Kg';
                            el.textContent = `${data.totals[tipo] || '0,0000'} ${un}`;
                        }
                    });
                }
            } catch (e) { console.error("Erro nos cards:", e); }
        }

        function atualizarRelogio() {
            const agora = new Date();
            const relogioEl = document.getElementById('relogio');
            if (relogioEl) {
                relogioEl.innerHTML = agora.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' }) + '<br>' + agora.toLocaleTimeString('pt-BR');
            }
        }

        function checkLogin() {
            const grad = localStorage.getItem('userGraduacao');
            const nome = localStorage.getItem('userNomeGuerra');
            const userEl = document.getElementById('user-info');
            if (!grad) {
                window.location.href = 'login.html';
            } else if (userEl) {
                userEl.innerHTML = `<p>Bem Vindo:</p><p class="user-nome">${grad} ${nome}</p>`;
            }
        }

        // Função única para gerar o relatório
        function gerarRelatorio() {
            const inicio = document.getElementById('rel-inicio').value; // Ex: 2026-01-01
            const fim = document.getElementById('rel-fim').value;      // Ex: 2026-01-18
            const tipo = document.getElementById('rel-tipo').value;

            // IMPORTANTE: Substitua 'SUA_URL_AQUI' pela URL do seu Script implantado
            const url = `https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec?action=pageRelatorio&inicio=${inicio}&fim=${fim}&tipo=${tipo}`;

            document.getElementById('iframe-relatorio').src = url;
            document.getElementById('modal-relatorio').style.display = 'block';
            document.getElementById('modal-filtro-relatorio').style.display = 'none';
        }

        function fecharModalRelatorio() {
            document.getElementById('modal-relatorio').style.display = 'none';
            document.getElementById('iframe-relatorio').src = ''; // Limpa o iframe ao fechar
        }


        // --- INICIALIZAÇÃO SEGURA ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            loadDrogas();

            // Listener Logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) btnLogout.onclick = () => {
                localStorage.clear();
                window.location.href = 'login.html';
            };

            // Listener Adicionar
            const btnAdd = document.getElementById('btn-adicionar-cadastro');
            if (btnAdd) btnAdd.onclick = () => toggleSidebar(true);

            // Listener Abrir Filtro Relatório (CORREÇÃO DO ERRO NULL AQUI)
            const btnRel = document.getElementById('btn-abrir-relatorio-modal') || document.getElementById('btn-abrir-filtro-relatorio');
            if (btnRel) {
                btnRel.onclick = () => {
                    document.getElementById('modal-filtro-relatorio').style.display = 'block';
                };
            }

            const btnFechar = document.getElementById('btn-fechar-sidebar');
            if (btnFechar) btnFechar.onclick = () => toggleSidebar(false);

            if (overlay) overlay.onclick = () => toggleSidebar(false);
            if (sidebar) sidebar.onsubmit = salvarDados;

        });
    </script>
</body>

</html>