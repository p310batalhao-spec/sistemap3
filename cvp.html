<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - MVI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="stylescvp.css">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3|CVP</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a>
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a>
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a>
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a>
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a>
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button>
        </nav>

        <main>
            <div class="saudacao">
                <h2>Crimes Violentos Contra o Patrimônio</h2>
                <p>Furto, Roubo, Tentativa de Roubo, Latrocínio, Extorção Mediante Sequestro</p>
            </div>
            <div class="TabelaEventos">
                <h3>Cadastro de CVP</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo CVP
                    </button>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div>

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="N° DO BOU">N° BOU</option>
                        <option value="DATA">Data</option>
                        <option value="CATEGORIA">Categoria</option>
                        <option value="ESAJ">ESAJ</option>
                        <option value="STATUS">Status</option>
                        <option value="LOCAL">Local</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor..." style="display: block;">

                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>
                </div>
                <div class="container-tabela">
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>DATA</th>
                                <th>Nº COP</th>
                                <th>TIPIFICAÇÃO</th>
                                <th>ENVOLVIMENTO</th>
                                <th>NOME</th>
                                <th>RG</th>
                                <th>CPF</th>
                                <th>IDADE</th>
                                <th>ALCUNHA</th>
                                <th>SEXO</th>
                                <th>MÃE</th>
                                <th>INSTRUMENTO</th>
                                <th>CIDADE</th>
                                <th>BAIRRO</th>
                                <th>PONTO REF</th>
                                <th>ENDEREÇO</th>
                                <th>DIA</th>
                                <th>MÊS</th>
                                <th>HORA</th>
                                <th>LATITUDE</th>
                                <th>LONGITUDE</th>
                                <th>AUTORIA</th>
                                <th>IDADE AUTORIA</th>
                                <th>SEXO AUTOR</th>
                                <th>ANTECEDENTE</th>
                                <th>SITUAÇÃO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="overlay-sidebar" class="overlay-sidebar"></div>

            <form class="sidbarform" id="form-materiais">
                <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
                <h4>Cadastro de Material Apreendido</h4>

                <input type="hidden" id="form-id" name="ID">

                <div class="formulario-scroll">
                    <div class="formulario">
                        <p>DATA</p>
                        <input type="date" name="DATA" id="data" required>
                    </div>
                    <div class="formulario">
                        <p>N° DO COP</p>
                        <input type="text" name="NBOU" id="nbou" required>
                    </div>
                    <div class="formulario">
                        <p>TIPIFICAÇÃO</p>
                        <select name="TIPIFICAÇÃO" id="Tipificação">TIPIFICAÇÃO
                            <option value="">Selecione a tipificação</option>
                            <option value="FURTO">Furto</option>
                            <option value="ROUBO">Roubo</option>
                            <option value="TENTATIVA DE ROUBO">Tentativa de Roubo</option>
                            <option value="LATROCÍNIO">Latrocínio</option>
                            <option value="EXTORÇÃO MEDIANTE SEQUESTRO">Extorção Mediante Sequestro</option>
                            <option value="APROPRIAÇÃO INDÉBITA">Apropriação Indébita</option>
                            <option value="DANO">Dano</option>
                            <option value="DANO QUALIFICADO">Dano Qualificado</option>
                            <option value="ESTELIONATO">Estelionato</option>
                            <option value="TENTATIVA DE FURTO">Tentativa de Furto</option>
                            <option value="FURTO QUALIFICADO">Furto Qualificado</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>RG</p>
                        <input type="text" name="RG" id="RG">
                    </div>
                    <div class="formulario">
                        <p>CPF</p>
                        <input type="text" name="CPF" id="CPF">
                    </div>
                    <div class="formulario">
                        <p>IDADE</p>
                        <input type="number" name="IDADE" id="IDADE">
                    </div>
                    <div class="formulario">
                        <p>ALCUNHA</p>
                        <input type="text" name="ALCUNHA" id="ALCUNHA">
                    </div>
                    <div class="formulario">
                        <p>SEXO</p>
                        <select name="SEXO" id="SEXO">
                            <option value="">Selecione o sexo</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>MÃE</p>
                        <input type="text" name="MÃE" id="MAE">
                    </div>
                    <div class="formulario">
                        <p>INSTRUMENTO</p>
                        <input type="text" name="INSTRUMENTO" id="INSTRUMENTO">
                    </div>
                    <div class="formulario">
                        <p>CIDADE</p>
                        <select name="CIDADE" id="CIDADE">CIDADE
                            <option value="">Selecione a cidade</option>
                            <option value="BELÉM">BELÉM</option>
                            <option value="CACIMBINHAS">CACIMBINHAS</option>
                            <option value="ESTRELA DE ALAGOAS">ESTRELA DE ALAGOAS</option>
                            <option value="IGACI">IGACI</option>
                            <option value="MAR VERMELHO">MAR VERMELHO</option>
                            <option value="MARIBONDO">MARIBONDO</option>
                            <option value="PALMEIRA DOS ÍNDIOS">PALMEIRA DOS ÍNDIOS</option>
                            <option value="PAULO JACINTO">PAULO JACINTO</option>
                            <option value="QUEBRANGULO">QUEBRANGULO</option>
                            <option value="TANQUE D'ARCA">TANQUE D'ARCA</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <P>BAIRRO</P>
                        <input type="text" name="BAIRRO" id="BAIRRO">
                    </div>
                    <div class="formulario">
                        <p>PONTO REF</p>
                        <input type="text" name="PONTO_REF" id="PONTO_REF">
                    </div>
                    <div class="formulario">
                        <p>ENDEREÇO</p>
                        <input type="text" name="ENDEREÇO" id="ENDEREÇO">
                    </div>
                    <div class="formulario">
                        <p>HORA</p>
                        <input type="time" name="HORA" id="HORA">
                    </div>
                    <div class="formulario">
                        <p>LATITUDE,LONGITUDE</p>
                        <input type="text" name="LAT_LONG" id="LAT_LONG">
                    </div>
                    <div class="formulario">
                        <p>AUTORIA</p>
                        <input type="text" name="AUTORIA" id="AUTORIA">
                    </div>
                    <div class="formulario">
                        <p>IDADE AUTORIA</p>
                        <input type="text" name="IDADE_AUTORIA" id="IDADE_AUTORIA">
                    </div>
                    <div class="formulario">
                        <p>SEXO AUTOR</p>
                        <input type="text" name="SEXO_AUTOR" id="SEXO_AUTORIA">
                    </div>
                    <div class="formulario">
                        <p>ANTECEDENTE</p>
                        <input type="text" name="ANTECEDENTE" id="ANTECEDENTE">
                    </div>
                    <div class="formulario">
                        <p>SITUAÇÃO</p>
                        <select name="SITUAÇÃO" id="SITUAÇÃO">
                            <option value="">Selecione a Situação</option>
                            <option value="EVADIDO">EVADIDO</option>
                            <option value="PRESO">PRESO</option>
                            <option value="SOCORRIDO">SOCORRIDO</option>
                            <option value="LIBERADO">LIBERADO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>GUARNIÇÃO</p>
                        <select name="GUARNIÇÃO" id="GUARNIÇÃO">
                            <option value="">Selecione a Guarnição</option>
                            <option value="TÁTICO URBANO">TÁTICO URBANO</option>
                            <option value="TÁTICO RURAL O1">TÁTICO RURAL 01</option>
                            <option value="TÁTICO RURAL 02">TÁTICO RURAL 02</option>
                            <option value="RP PALMEIRA 01">RP PALMEIRA 01</option>
                            <option value="RP PALMEIRA 02">RP PALMEIRA 02</option>
                            <option value="RP QUEBRANGULO">RP QUEBRANGULO</option>
                            <option value="RP IGACI">RP IGACI</option>
                            <option value="RP MARIBONDO">RP MARIBONDO</option>
                            <option value="RP CACIMBINHAS">RP CACIMBINHAS</option>
                            <option value="RP ESTRELA/MINADOR">RP ESTRELA/MINADOR</option>
                            <option value="RP MARVERMELHO/PAULO JACINTO">RP MAR VERMELHO/PAULO JACINTO</option>
                            <option value="RP BELÉM/TANQUE D'ARCA">RP BELÉM/TANQUE D'ARCA</option>
                        </select>
                    </div>
                </div><!--termina formulario-scroll-->
                <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                    style="width: 100%; padding: 15px; margin-top: 20px;">
                    SALVAR DADOS
                </button>
            </form><!--termina sidebarform-->
        </main>
    </section>
</body>
<footer>
    <div>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </div>
</footer>
<script>
    // Configurações Iniciais
    const API_URL = "https://script.google.com/macros/s/AKfycbzgC94-IDT31Mzmz8T1u3yvuHvM3Y73WRqjEeWIG3cKxNHDACMH1rwRSNxiX3APUTWi/exec";
    const sidebar = document.querySelector('.sidbarform'); // Verifique se a classe é sidbarform
    const overlay = document.getElementById('overlay-sidebar');
    const form = document.getElementById('form-materiais');
    const tabelaCorpo = document.querySelector('#tabela-materiais tbody');
    const btnAdicionar = document.getElementById('btn-adicionar-cadastro');
    const btnFecharSidebar = document.getElementById('btn-fechar-sidebar');

    // --- 1. FUNÇÕES DE ABERTURA E FECHAMENTO ---

    // Ao clicar em ADICIONAR (Novo Registro)
    if (btnAdicionar) {
        btnAdicionar.addEventListener('click', () => {
            form.reset(); // Limpa campos de texto
            document.getElementById('form-id').value = ""; // Limpa o ID (essencial para ser NOVO)
            sidebar.classList.add('active');
            overlay.classList.add('active');
            console.log("Abrindo para novo registro...");
        });
    }

    // Ao clicar em FECHAR
    if (btnFecharSidebar) {
        btnFecharSidebar.addEventListener('click', () => {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            form.reset();
        });
    }

    // Fechar ao clicar no fundo escuro
    overlay.addEventListener('click', () => {
        btnFecharSidebar.click();
    });

    // --- 2. CARREGAR E ORDENAR DADOS ---

    async function carregarDados() {
        try {
            const response = await fetch(API_URL, { redirect: "follow" });
            let dados = await response.json();

            // Ordena do ID maior (mais recente) para o menor
            dados.sort((a, b) => Number(b.ID) - Number(a.ID));

            tabelaCorpo.innerHTML = "";

            const colunasPlanilha = [
                'ID', 'DATA', 'NUMERO COP', 'TIPIFICAÇÃO', 'ENVOLVIMENTO', 'NOME', 'RG', 'CPF', 
                'IDADE', 'ALCUNHA', 'SEXO', 'MÃE', 'INSTRUMENTO', 'CIDADE', 'BAIRRO', 
                'PONTO REF', 'ENDEREÇO', 'DIA', 'MÊS', 'HORA', 'LATITUDE', 'LONGITUDE', 
                'AUTORIA', 'IDADE AUTORIA', 'SEXO AUTOR', 'ANTECEDENTE', 'SITUAÇÃO'
            ];

            dados.forEach(item => {
                const linha = document.createElement('tr');
                colunasPlanilha.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = item[col] || ""; 
                    linha.appendChild(td);
                });

                const tdAcao = document.createElement('td');
                const btnEditar = document.createElement('button');
                btnEditar.className = 'btn-editar';
                btnEditar.innerText = 'EDITAR';
                btnEditar.onclick = () => preencherFormulario(item);
                tdAcao.appendChild(btnEditar);
                linha.appendChild(tdAcao);
                tabelaCorpo.appendChild(linha);
            });

            document.getElementById('mensagem-carregamento').style.display = 'none';
        } catch (error) {
            console.error("Erro ao carregar:", error);
        }
    }

    // --- 3. EDITAR (PREENCHER FORMULÁRIO COM DADOS DA LINHA) ---

    function preencherFormulario(item) {
        form.reset();
        sidebar.classList.add('active');
        overlay.classList.add('active');

        // Preenche o campo oculto com o ID da linha (essencial para EDITAR)
        document.getElementById('form-id').value = item['ID'] || "";

        // Preenche os demais campos
        document.getElementById('data').value = converterDataParaInput(item['DATA']);
        document.getElementById('nbou').value = item['NUMERO COP'] || "";
        document.getElementById('Tipificação').value = item['TIPIFICAÇÃO'] || "";
        document.getElementById('Envolvimento').value = item['ENVOLVIMENTO'] || "";
        document.getElementById('Nome').value = item['NOME'] || "";
        document.getElementById('RG').value = item['RG'] || "";
        document.getElementById('CPF').value = item['CPF'] || "";
        document.getElementById('IDADE').value = item['IDADE'] || "";
        document.getElementById('ALCUNHA').value = item['ALCUNHA'] || "";
        document.getElementById('SEXO').value = item['SEXO'] || "";
        document.getElementById('MAE').value = item['MÃE'] || "";
        document.getElementById('INSTRUMENTO').value = item['INSTRUMENTO'] || "";
        document.getElementById('CIDADE').value = item['CIDADE'] || "";
        document.getElementById('BAIRRO').value = item['BAIRRO'] || "";
        document.getElementById('PONTO_REF').value = item['PONTO REF'] || "";
        document.getElementById('ENDEREÇO').value = item['ENDEREÇO'] || "";
        document.getElementById('HORA').value = item['HORA'] || "";
        
        // Trata Latitude e Longitude se vierem juntas ou separadas
        const lat = item['LATITUDE'] || "";
        const long = item['LONGITUDE'] || "";
        document.getElementById('LAT_LONG').value = lat && long ? `${lat},${long}` : "";

        document.getElementById('AUTORIA').value = item['AUTORIA'] || "";
        document.getElementById('IDADE_AUTORIA').value = item['IDADE AUTORIA'] || "";
        document.getElementById('SEXO_AUTORIA').value = item['SEXO AUTOR'] || "";
        document.getElementById('ANTECEDENTE').value = item['ANTECEDENTE'] || "";
        document.getElementById('SITUAÇÃO').value = item['SITUAÇÃO'] || "";
        
        console.log("Modo edição ativado para o ID: " + item['ID']);
    }

    // --- 4. SALVAR (NOVO OU EDIÇÃO) ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btnSalvar = document.getElementById('btn-salvar-form');
        btnSalvar.innerText = "Processando...";
        btnSalvar.disabled = true;

        const formData = new FormData(form);
        const idParaEnvio = document.getElementById('form-id').value;

        const dados = {
            ID: idParaEnvio, // Se estiver vazio, o GS cria novo. Se tiver valor, o GS edita.
            DATA: formData.get('DATA'),
            NBOU: formData.get('NBOU'),
            TIPIFICACAO: formData.get('TIPIFICAÇÃO'),
            ENVOLVIMENTO: formData.get('ENVOLVIMENTO'),
            NOME: formData.get('NOME'),
            RG: formData.get('RG'),
            CPF: formData.get('CPF'),
            IDADE: formData.get('IDADE'),
            ALCUNHA: formData.get('ALCUNHA'),
            SEXO: formData.get('SEXO'),
            MAE: formData.get('MÃE'),
            INSTRUMENTO: formData.get('INSTRUMENTO'),
            CIDADE: formData.get('CIDADE'),
            BAIRRO: formData.get('BAIRRO'),
            PONTO_REF: formData.get('PONTO_REF'),
            ENDERECO: formData.get('ENDEREÇO'),
            HORA: formData.get('HORA'),
            LAT_LONG: formData.get('LAT_LONG'),
            AUTORIA: formData.get('AUTORIA'),
            IDADE_AUTORIA: formData.get('IDADE_AUTORIA'),
            SEXO_AUTOR: formData.get('SEXO_AUTOR'),
            ANTECEDENTE: formData.get('ANTECEDENTE'),
            SITUACAO: formData.get('SITUAÇÃO')
        };

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(dados),
                redirect: "follow"
            });
            
            alert("Operação concluída com sucesso!");
            form.reset();
            document.getElementById('form-id').value = "";
            carregarDados();
            btnFecharSidebar.click();
        } catch (err) {
            alert("Erro ao processar: " + err);
        } finally {
            btnSalvar.innerText = "SALVAR DADOS";
            btnSalvar.disabled = false;
        }
    });

    // Utilitários
    function converterDataParaInput(dataStr) {
        if (!dataStr) return "";
        const partes = dataStr.split('/');
        if (partes.length !== 3) return "";
        return `${partes[2]}-${partes[1]}-${partes[0]}`;
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', carregarDados);
    
    // Funções de Relógio e Login (Insira as suas aqui...)
</script>