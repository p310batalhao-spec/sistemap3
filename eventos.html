<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - Eventos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleseventos.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html" class="active">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->

        <div id="overlay-sidebar" class="overlay-sidebar"></div>

        <form class="sidbarform" id="form-eventos">
            <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
            <h4>Cadastro de Eventos</h4>

            <input type="hidden" id="form-id" name="ID">

            <div class="formulario-scroll">
                <div class="formulario">
                    <p>PROTOCOLO</p>
                    <input type="text" name="PROTOCOLO" id="protocolo">
                </div>
                <div class="formulario">
                    <p>DATA (DD/MM/AAAA)</p>
                    <input type="date" name="DATA" id="data-evento">
                </div>
                <div class="formulario">
                    <p>CIDADE</p>
                    <select name="CIDADE" id="cidade-evento">
                        <option value="BELÉM">BELÉM</option>
                        <option value="CACIMBINHAS">CACIMBINHAS</option>
                        <option value="ESTELA DE ALAGOAS">ESTELA DE ALAGOAS</option>
                        <option value="IGACI">IGACI</option>
                        <option value="MAR VERMELHO">MAR VERMELHO</option>
                        <option value="MARIBONDO">MARIBONDO</option>
                        <option value="MINADOR DO NEGRÃO">MINADOR DO NEGRÃO</option>
                        <option value="PALMEIRA DOS ÍNDIOS">PALMEIRA DOS ÍNDIOS</option>
                        <option value="PAULO JACINTO">PAULO JACINTO</option>
                        <option value="QUEBRANGULO">QUEBRANGULO</option>
                        <option value="TANQUE D'ARCA">TANQUE D'ARCA</option>                        
                    </select>
                </div>
                <div class="formulario">
                    <p>NOME DO EVENTO</p>
                    <input type="text" name="NOME DO EVENTO" id="nome-evento">
                </div>
                <div class="formulario">
                    <p>LOCAL DO EVENTO</p>
                    <input type="text" name="LOCAL DO EVENTO" id="local-evento">
                </div>
                <div class="formulario">
                    <p>HORÁRIO DE INÍCIO</p>
                    <input type="time" name="HORÁRIO DE INÍCIO" id="horario-inicio">
                </div>
                <div class="formulario">
                    <p>HORÁRIO DE TÉRMINO</p>
                    <input type="time" name="HORÁRIO DE TÉRMINO" id="horario-termino">
                </div>
                <div class="formulario">
                    <p>ESTIMATIVA DE PÚBLICO</p>
                    <input type="number" name="ESTIMATIVA DE PÚBLICO" id="estimativa-publico">
                </div>
                <div class="formulario">
                    <p>ORGANIZAÇÃO</p>
                    <input type="text" name="ORGANIZAÇÃO" id="organizacao-evento">
                </div>
                <div class="formulario">
                    <p>NOME DO RESPONSÁVEL</p>
                    <input type="text" name="NOME DO RESPONSÁVEL" id="nome-responsavel">
                </div>
                <div class="formulario">
                    <p>CPF</p>
                    <input type="number" name="CPF" id="cpf-responsavel">
                </div>
                <div class="formulario">
                    <p>TELEFONE</p>
                    <input type="tel" name="TELEFONE" id="telefone-responsavel">
                </div>
            </div>

            <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                style="width: 100%; padding: 15px; margin-top: 20px;">
                SALVAR DADOS
            </button>
        </form><!--termina sidebarform-->
        <main>
            <div class="TabelaEventos">
                <h3>Cadastro e Gerenciamento de Eventos</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo Evento
                    </button>
                    <a href="https://script.google.com/macros/s/AKfycbw7PcNaoXUERn9ZuIBdiWG5_JeZZf-r0B1xjAKZU7fz-k-7Pg8PtNFIvyZIF091nbtkTg/exec"
                        target="_blank" class="btnQuadroEventos">Gerar Quadro de Eventos</a>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div>

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="DATA">Data</option>
                        <option value="CIDADE">Cidade</option>
                        <option value="PORTE">Porte</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor..." style="display: block;">

                    <select id="filtro-valor-select-porte" style="display: none;">
                        <option value="">Todos os Portes</option>
                        <option value="PEQUENO PORTE">Pequeno Porte</option>
                        <option value="MÉDIO PORTE">Médio Porte</option>
                        <option value="GRANDE PORTE">Grande Porte</option>
                        <option value="N/A">N/A</option>
                    </select>

                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>
                </div>
                <div class="tabela-container">
                    <table id="tabela-eventos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>PORTE</th>
                                <th>PROTOCOLO</th>
                                <th>DATA</th>
                                <th>CIDADE</th>
                                <th>NOME DO EVENTO</th>
                                <th>LOCAL DO EVENTO</th>
                                <th>INÍCIO</th>
                                <th>TÉRMINO</th>
                                <th>PÚBLICO</th>
                                <th>ORGANIZAÇÃO</th>
                                <th>RESPONSÁVEL</th>
                                <th>CPF</th>
                                <th>TELEFONE</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>
</body>
<footer>
    <div>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </div>
</footer>

<script>
    // Armazenamento global dos dados para filtragem e edição
    let allEventos = [];

    // URL do seu Google Apps Script
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyTNCA2XY0YMhJHpgnIigTijA5JaVOTvCVukrOPrKNlGvryiFHdURIe3daupK8Si1qu/exec';

    // Elementos da Interface Sidebar
    const sidebar = document.getElementById('form-eventos');
    const overlay = document.getElementById('overlay-sidebar');
    const btnFecharSidebar = document.getElementById('btn-fechar-sidebar');

    /**
     * 1. CONTROLE DE SESSÃO (LOGIN / LOGOUT)
     */
    function checkLogin() {
        const graduacao = localStorage.getItem('userGraduacao');
        const nomeGuerra = localStorage.getItem('userNomeGuerra');
        const userInfoEl = document.getElementById('user-info');
        
        if (graduacao && nomeGuerra) {
            if (userInfoEl) {
                userInfoEl.innerHTML = `
                    <p>Bem Vindo(a):</p>
                    <p class="user-nome">${graduacao} ${nomeGuerra}</p>
                `;
            }
        } else {
            alert('Sessão expirada ou não iniciada. Redirecionando para a tela de Login.');
            window.location.href = 'login.html';
        }
    }

    function logout() {
        localStorage.removeItem('userGraduacao');
        localStorage.removeItem('userNomeGuerra');
        alert('Logout realizado com sucesso!');
        window.location.href = 'login.html';
    }

    /**
     * 2. RELÓGIO EM TEMPO REAL
     */
    function atualizarRelogio() {
        const agora = new Date();
        const el = document.getElementById('relogio');
        if (el) {
            el.innerHTML = agora.toLocaleDateString('pt-BR', { 
                weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' 
            }) + '<br>' + agora.toLocaleTimeString('pt-BR');
        }
    }

    /**
     * 3. CONTROLE DA SIDEBAR (ABRIR/FECHAR/PREENCHER)
     */
    function toggleSidebar(show = true, data = null) {
        if (show) {
            sidebar.reset(); 
            document.getElementById('form-id').value = ''; 
            
            if (data) {
                // Preenchimento dos campos para edição
                document.getElementById('form-id').value = data.ID || '';
                document.getElementById('protocolo').value = data.PROTOCOLO || '';
                document.getElementById('data-evento').value = data.DATA || '';
                
                // CORREÇÃO CIDADE: Ajusta o Select para o valor vindo da planilha
                const cidadeSelect = document.getElementById('cidade-evento');
                if (data.CIDADE) {
                    // Garante que o valor combine com as options (Maiúsculas e sem espaços extras)
                    cidadeSelect.value = data.CIDADE.toString().toUpperCase().trim();
                }

                document.getElementById('nome-evento').value = data['NOME DO EVENTO'] || '';
                document.getElementById('local-evento').value = data['LOCAL DO EVENTO'] || '';
                document.getElementById('horario-inicio').value = data['HORÁRIO DE INÍCIO'] || '';
                document.getElementById('horario-termino').value = data['HORÁRIO DE TÉRMINO'] || '';
                document.getElementById('estimativa-publico').value = data['ESTIMATIVA DE PÚBLICO'] || '';
                document.getElementById('organizacao-evento').value = data.ORGANIZAÇÃO || '';
                document.getElementById('nome-responsavel').value = data['NOME DO RESPONSÁVEL'] || '';
                document.getElementById('cpf-responsavel').value = data.CPF || '';
                document.getElementById('telefone-responsavel').value = data.TELEFONE || '';
            }
            sidebar.classList.add('active');
            overlay.classList.add('active');
        } else {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }
    }

    /**
     * 4. RENDERIZAÇÃO DA TABELA
     */
    function getClassificacao(publico) {
        const numPublico = parseInt(publico, 10);
        if (isNaN(numPublico) || numPublico <= 0) return { nome: 'N/A', classe: 'na-porte' };
        if (numPublico > 1000) return { nome: 'GRANDE PORTE', classe: 'grande-porte' };
        if (numPublico > 500) return { nome: 'MÉDIO PORTE', classe: 'medio-porte' };
        return { nome: 'PEQUENO PORTE', classe: 'pequeno-porte' };
    }

    function renderTable(dataToRender) {
        const tbody = document.querySelector('#tabela-eventos tbody');
        const mensagem = document.getElementById('mensagem-carregamento');
        tbody.innerHTML = ''; 

        if (dataToRender && dataToRender.length) {
            if(mensagem) mensagem.style.display = 'none';
            dataToRender.forEach(item => {
                const row = tbody.insertRow();
                const classif = getClassificacao(item['ESTIMATIVA DE PÚBLICO']);

                row.insertCell().textContent = item.ID || '';
                const porteCell = row.insertCell();
                porteCell.innerHTML = `<span class="porte-badge ${classif.classe}">${classif.nome}</span>`;

                const chavesDisplay = [
                    'PROTOCOLO', 'DATA', 'CIDADE', 'NOME DO EVENTO', 'LOCAL DO EVENTO',
                    'HORÁRIO DE INÍCIO', 'HORÁRIO DE TÉRMINO', 'ESTIMATIVA DE PÚBLICO',
                    'ORGANIZAÇÃO', 'NOME DO RESPONSÁVEL', 'CPF', 'TELEFONE'
                ];

                chavesDisplay.forEach(key => {
                    row.insertCell().textContent = item[key] || '';
                });

                const acoesCell = row.insertCell();
                const btnEdit = document.createElement('button');
                btnEdit.textContent = 'Editar';
                btnEdit.className = 'btn-editar-evento'; // Use a classe do seu CSS
                btnEdit.style.cssText = "background-color: #2c3e50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;";
                btnEdit.onclick = () => toggleSidebar(true, item);
                acoesCell.appendChild(btnEdit);
            });
        }
    }

    /**
     * 5. COMUNICAÇÃO COM O GOOGLE SHEETS
     */
    async function fetchData() {
        const mensagem = document.getElementById('mensagem-carregamento');
        try {
            if(mensagem) mensagem.style.display = 'block';
            const response = await fetch(`${WEBAPP_URL}?action=read`);
            allEventos = await response.json();
            renderTable(allEventos);
        } catch (error) {
            console.error("Erro ao buscar dados:", error);
        } finally {
            if(mensagem) mensagem.style.display = 'none';
        }
    }

    /**
     * 6. INICIALIZAÇÃO E EVENTOS
     */
    document.addEventListener('DOMContentLoaded', function () {
        checkLogin();
        atualizarRelogio();
        setInterval(atualizarRelogio, 1000);
        fetchData();

        // Listeners da Sidebar
        document.getElementById('btn-adicionar-cadastro').onclick = () => toggleSidebar(true);
        btnFecharSidebar.onclick = () => toggleSidebar(false);
        overlay.onclick = () => toggleSidebar(false);

        // Listener Logout
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) btnLogout.onclick = logout;

        // Submissão do Formulário (Salvar/Editar)
        sidebar.onsubmit = async (e) => {
            e.preventDefault();
            const btnSalvar = document.getElementById('btn-salvar-form');
            btnSalvar.disabled = true;
            btnSalvar.textContent = "Gravando...";

            const formData = new FormData(sidebar);
            const payload = Object.fromEntries(formData.entries());
            payload.action = payload.ID ? 'update' : 'create';

            try {
                const res = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(payload)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    alert('Dados processados com sucesso!');
                    toggleSidebar(false);
                    fetchData();
                }
            } catch (err) {
                alert('Erro ao salvar no banco de dados.');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.textContent = "SALVAR DADOS";
            }
        };

        // Lógica de Filtro
        document.getElementById('btn-aplicar-filtro').onclick = () => {
            const tipo = document.getElementById('filtro-tipo').value;
            const valor = document.getElementById('filtro-valor-text').value.toUpperCase();
            if (!tipo || !valor) {
                renderTable(allEventos);
                return;
            }
            const filtrados = allEventos.filter(item => 
                String(item[tipo] || '').toUpperCase().includes(valor)
            );
            renderTable(filtrados);
            document.getElementById('btn-limpar-filtro').style.display = 'inline-block';
        };

        document.getElementById('btn-limpar-filtro').onclick = function() {
            renderTable(allEventos);
            this.style.display = 'none';
            document.getElementById('filtro-valor-text').value = '';
        };
    });
</script>

</html>