<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Sistema de Gerenciamento P3</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div> <!--termina cabecalhotexto-->
        </div><!--termina header-info-left-->

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="user-notification">
                <div class="exibirusuario" id="user-info"></div>
                <div class="notification-container">
                    <span class="material-icons" id="bell-icon">notifications</span>
                    <span class="badge" id="notif-count" style="display: none;">0</span>
                    <div class="notif-dropdown" id="notif-dropdown">
                        <div class="notif-header">Notificações</div>
                        <div id="notif-items">
                            <p class="empty-msg">Nenhuma notificação nova</p>
                        </div><!--termina notif-items-->
                    </div><!--termina notif-dropdown-->
                </div><!--termina notification-container-->
            </div><!--termina user-notification-->
        </div><!--termina header-info-right-->
    </header><!--termina header-->

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html" class="active">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->
        <main>
            <div class="saudacao">
                <h2>Bem-vindo ao Sistema de Gerenciamento P3</h2>
                <p>Utilize o menu lateral para navegar entre as seções do sistema.</p>
            </div>

            <section class="dashboard">
                <a href="mvi.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/skull.png" alt="skull" />
                    <p>MVI - Mortes Violentas</p>
                    <p id="numeromvi" class="numero">--</p>
                </a><!--termina o mvi-->

                <a href="cvp.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/robber.png" alt="robber" />
                    <p>CVP - Crimes Contra o Patrimônio</p>
                    <p id="numerocvp" class="numero">--</p>
                </a>
                <a href="tco.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/morale.png" alt="morale" />
                    <p>TCO - Termos Circunstanciados</p>
                    <p id="numerotco" class="numero">--</p>
                </a> <!--termina o tco-->

                <a href="violenciadomestica.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/windows/32/hand.png" alt="hand" />
                    <p>Violência Doméstica</p>
                    <p id="violenciadomestica" class="numero">--</p>
                </a> <!--termina violencia domestica-->

                <div class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/gun.png" alt="gun" />
                    <p>Armas Apreenndidas</p>
                    <p id="armasapreendidas" class="numero">--</p>
                </div> <!--termina armas apreendidas-->

                <a href="drogas.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/marijuana-leaf.png"
                        alt="Drogas Apreendidas" />
                    <p>Drogas Apreendidas</p>
                    <p id="numerodrogas" class="numero">--</p>
                </a> <!--termina drogas apreendidas-->

                <a href="ait.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios-glyphs/30/policeman-male.png"
                        alt="policeman-male" />
                    <p>Infrações de Trânsito</p>
                    <p class="numero" id="numeroait">50</p>
                </a> <!--termina o ait-->

                <a href="materiais.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                    <p>Materiais Apreendidos</p>
                    <p class="numero" id="numeromateriais">--</p>
                </a><!--termina materiais apreendidos-->

                <a href="mandado.html" class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-outlines-amoghdesign/32/external-balance-law-crime-and-justice-outlines-amoghdesign.png"
                        alt="external-balance-law-crime-and-justice-outlines-amoghdesign" />
                    <p>Cumprimentos de Mandados</p>
                    <p id="numeromandados" class="numero">--</p>
                </a><!--termina mandados-->

                <div class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/64/external-boombox-music-xnimrodx-lineal-xnimrodx.png"
                        alt="external-boombox-music-xnimrodx-lineal-xnimrodx" />
                    <p>Perturbação do Sossego</p>
                    <p id="numeroperturbacaodosossego" class="numero">--</p>
                </div><!--termina perturbação do sossego-->

            </section>
        </main>
    </section>

    <footer>
        <div>
            <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<script>
        // ********************************************************************
        // ** ATENÇÃO: SUBSTITUA AS URLs ABAIXO PELAS SUAS URLs REAIS **
        // ********************************************************************
        // Usando um nome mais claro para a URL de cada App
        const WEBAPP_URL_AIT = 'https://script.google.com/macros/s/AKfycbyNpjC9Ul4XRllFSciCj6hA62u74K8VIdXo1ecND-VCg1RiJCETqCWnrKKNN3bQtChOTg/exec';
        const WEBAPP_URL_DROGAS = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        const WEBAPP_URL_TCO = 'https://script.google.com/macros/s/AKfycbxXQhiX_EOskIWziWh2vG5UvuaOKBmv-7JIhBcghLlEiBpBEUtUV8Wn9M2Wk6kLtbgf/exec';
        const WEBAPP_URL_MATERIAIS = 'https://script.google.com/macros/s/AKfycbyftHcIS_0isNZsUsWrNBgOItkKeLMJbrhnpPz3zj4m0-5Vczkf2xDKrdpI-dMsI-9mQg/exec'; // URL do Apps Script de Materiais
        const API_URL = "https://script.google.com/macros/s/AKfycbzpoyFungNK4VL99YrPj_jCF0GwBtUF0w8wXLhZxgbNUVbGbU3CxLS0n6-jOiqfASCJTA/exec";

        // --- FUNÇÕES DE UTILIDADE (MANTIDAS) ---

        function atualizarRelogio() {
            const agora = new Date();
            const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
            const dataFormatada = agora.toLocaleDateString('pt-BR', opcoesData);
            const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('relogio').innerHTML = `${dataFormatada} <br> ${horaFormatada}`;
        }

        function checkLogin() {
            const graduacao = localStorage.getItem('userGraduacao');
            const nomeGuerra = localStorage.getItem('userNomeGuerra');
            const userInfoEl = document.getElementById('user-info');

            if (graduacao && nomeGuerra) {
                userInfoEl.innerHTML = `
                <p>Bem Vindo(a):</p>
                <p class="user-nome">${graduacao} ${nomeGuerra}</p>
            `;
            } else {
                alert('Sessão expirada ou não iniciada. Redirecionando para a tela de Login.');
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('userGraduacao');
            localStorage.removeItem('userNomeGuerra');
            alert('Logout realizado com sucesso!');
            window.location.href = 'login.html';
        }


        // --- FUNÇÃO OTIMIZADA PARA CONTADORES (GERAL) ---

        function updateCount(url, action, elementId) {
            const currentYear = new Date().getFullYear();
            $(`#${elementId}`).text('...');

            $.ajax({
                url: url,
                type: 'GET',
                data: {
                    action: action,
                    year: currentYear
                },
                dataType: 'json',
                success: function (response) {
                    if (response.status === 'success' && response.count !== undefined) {
                        $(`#${elementId}`).text(response.count);
                    } else {
                        $(`#${elementId}`).text('ERRO');
                        console.error(`Erro ao carregar contagem ${elementId}: ${response.message || 'Erro de comunicação.'}`);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $(`#${elementId}`).text('FALHA');
                    console.error(`Erro na comunicação com o Apps Script (${elementId}):`, textStatus, errorThrown);
                }
            });
        }

        // --- NOVA FUNÇÃO: CONTAGEM DE HOMICÍDIOS (MVI) ---
        async function atualizarCardMVI() {
            try {
                // Chama o script pedindo a ação específica para o servidor processar
                const response = await fetch(`${API_URL}?action=countHomicidios`);
                const resultado = await response.json();
                
                const elementoMvi = document.getElementById('numeromvi');
                if (elementoMvi) {
                    // Se o servidor retornar o total, exibe, senão coloca 0
                    elementoMvi.innerText = resultado.total !== undefined ? resultado.total : 0;
                }
            } catch (error) {
                console.error("Erro ao carregar contagem MVI:", error);
                if(document.getElementById('numeromvi')) {
                    document.getElementById('numeromvi').innerText = "0";
                }
            }
        }


        // --- FUNÇÃO ESPECÍFICA PARA DROGAS (Soma o Peso Anual) ---
        async function atualizarDrogas() {
            if (typeof WEBAPP_URL_DROGAS === 'undefined') {
                console.error("ERRO: A variável 'WEBAPP_URL_DROGAS' não está definida.");
                return;
            }

            const elementoContador = document.getElementById('numerodrogas');
            const elementoTitulo = elementoContador ? elementoContador.previousElementSibling : null;

            if (elementoContador) {
                elementoContador.textContent = '...';
            }

            const currentYear = new Date().getFullYear();
            const url = `${WEBAPP_URL_DROGAS}?action=sumDrogasPeso&year=${currentYear}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    const totalFormatado = String(data.total).replace('.', ',');

                    if (elementoTitulo) {
                        elementoTitulo.textContent = 'Peso Total (Ano Atual)';
                    }
                    if (elementoContador) {
                        elementoContador.textContent = `${totalFormatado} Kg`;
                    }

                } else {
                    console.error('Erro ao carregar soma de peso de drogas:', data.message);
                    if (elementoContador) {
                        elementoContador.textContent = 'ERRO';
                    }
                }
            } catch (error) {
                console.error('Erro na requisição da soma de drogas:', error);
                if (elementoContador) {
                    elementoContador.textContent = 'FALHA';
                }
            }
        }

        let lastCountAIT = localStorage.getItem('lastCountAIT') || 0;

        function checkNewNotifications() {
            fetch(WEBAPP_URL_AIT + "?action=countAITs")
                .then(res => res.json())
                .then(data => {
                    const currentCount = data.numeroait;
                    if (currentCount > lastCountAIT && lastCountAIT != 0) {
                        const novos = currentCount - lastCountAIT;
                        addNotification(`Existem ${novos} novas inclusões de AIT.`);
                        const badge = document.getElementById('notif-count');
                        badge.innerText = novos;
                        badge.style.display = 'block';
                    }
                });
        }

        function addNotification(text) {
            const container = document.getElementById('notif-items');
            const emptyMsg = container.querySelector('.empty-msg');
            if (emptyMsg) emptyMsg.remove();

            const item = document.createElement('div');
            item.className = 'notif-item';
            item.innerHTML = `<strong>Novo Registro:</strong><br>${text}`;
            container.prepend(item);
        }

        document.getElementById('bell-icon').addEventListener('click', () => {
            const dropdown = document.getElementById('notif-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            document.getElementById('notif-count').style.display = 'none';
        });

        setInterval(checkNewNotifications, 60000);


        // --- INICIALIZAÇÃO GERAL ---

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializa o Relógio
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);

            // Verifica Login
            checkLogin();

            // Anexa Listener de Logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', logout);
            }

            // CARREGA OS CONTADORES DO DASHBOARD
            
            // 1. Contagem AIT 
            updateCount(WEBAPP_URL_AIT, 'countAITs', 'numeroait');

            // 2. Contagem Drogas
            atualizarDrogas();

            // 3. Contagem TCO
            updateCount(WEBAPP_URL_TCO, 'countTCOs', 'numerotco');

            // 4. Contagem MVI (Homicídios) - NOVA IMPLEMENTAÇÃO
            atualizarCardMVI();

            // 5. Contagem Materiais Apreendidos
            if (WEBAPP_URL_MATERIAIS && !WEBAPP_URL_MATERIAIS.includes('SUA_URL')) {
                updateCount(WEBAPP_URL_MATERIAIS, 'countMateriais', 'numeromateriais');
            } else {
                $('#numeromateriais').text('Set URL');
            }
        });
    </script>


</html>