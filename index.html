<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Sistema de Gerenciamento P3</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html" class="active">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a>
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a>
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a>
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a>
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a>
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button>
        </nav>
        <main>
            <div class="saudacao">
                <h2>Bem-vindo ao Sistema de Gerenciamento P3</h2>
                <p>Utilize o menu lateral para navegar entre as seções do sistema.</p>
            </div>

            <section class="dashboard">
                <a href="mvi.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/skull.png" alt="skull" />
                    <p>MVI - Mortes Violentas</p>
                    <p id="numeromvi" class="numero">--</p>
                </a><!--termina o mvi-->

                <a href="cvp.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/robber.png" alt="robber" />
                    <p>CVP - Crimes Contra o Patrimônio</p>
                    <p id="numerocvp" class="numero">--</p>
                </a>
                <a href="tco.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/morale.png" alt="morale" />
                    <p>TCO - Termos Circunstanciados</p>
                    <p id="numerotco" class="numero">--</p>
                </a> <!--termina o tco-->
                
                <a href="violenciadomestica.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/windows/32/hand.png" alt="hand" />
                    <p>Violência Doméstica</p>
                    <p id="violenciadomestica" class="numero">--</p>
                </a> <!--termina violencia domestica-->
                
                <div class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/gun.png" alt="gun" />
                    <p>Armas Apreenndidas</p>
                    <p id="armasapreendidas" class="numero">--</p>
                </div> <!--termina armas apreendidas-->

                <a href="drogas.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/marijuana-leaf.png"
                        alt="Drogas Apreendidas" />
                    <p>Drogas Apreendidas</p>
                    <p id="numerodrogas" class="numero">--</p>
                </a> <!--termina drogas apreendidas-->

                <a href="ait.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios-glyphs/30/policeman-male.png"
                        alt="policeman-male" />
                    <p>Infrações de Trânsito</p>
                    <p class="numero" id="numeroait">50</p>
                </a> <!--termina o ait-->

                <a href="materiais.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                    <p>Materiais Apreendidos</p>
                    <p class="numero" id="numeromateriais">--</p> 
                </a><!--termina materiais apreendidos-->

                <a href="mandado.html" class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-outlines-amoghdesign/32/external-balance-law-crime-and-justice-outlines-amoghdesign.png"
                        alt="external-balance-law-crime-and-justice-outlines-amoghdesign" />
                    <p>Cumprimentos de Mandados</p>
                    <p id="numeromandados" class="numero">--</p>
                </a><!--termina mandados-->

                <div class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/64/external-boombox-music-xnimrodx-lineal-xnimrodx.png"
                        alt="external-boombox-music-xnimrodx-lineal-xnimrodx" />
                    <p>Perturbação do Sossego</p>
                    <p id="numeroperturbacaodosossego" class="numero">--</p>
                </div><!--termina perturbação do sossego-->

            </section>
        </main>
    </section>

    <footer>
        <div>
            <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script>
        // ********************************************************************
        // ** ATENÇÃO: SUBSTITUA AS URLs ABAIXO PELAS SUAS URLs REAIS **
        // ********************************************************************
        // Usando um nome mais claro para a URL de cada App
        const WEBAPP_URL_AIT = 'https://script.google.com/macros/s/AKfycbyNpjC9Ul4XRllFSciCj6hA62u74K8VIdXo1ecND-VCg1RiJCETqCWnrKKNN3bQtChOTg/exec';
        const WEBAPP_URL_DROGAS = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        const WEBAPP_URL_TCO = 'https://script.google.com/macros/s/AKfycbxXQhiX_EOskIWziWh2vG5UvuaOKBmv-7JIhBcghLlEiBpBEUtUV8Wn9M2Wk6kLtbgf/exec'; 
        const WEBAPP_URL_MATERIAIS = 'https://script.google.com/macros/s/AKfycbyftHcIS_0isNZsUsWrNBgOItkKeLMJbrhnpPz3zj4m0-5Vczkf2xDKrdpI-dMsI-9mQg/exec'; // <-- NOVO: URL do Apps Script de Materiais


        // --- FUNÇÕES DE UTILIDADE (MANTIDAS) ---

        function atualizarRelogio() {
            const agora = new Date();
            const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
            const dataFormatada = agora.toLocaleDateString('pt-BR', opcoesData);
            const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('relogio').innerHTML = `${dataFormatada} <br> ${horaFormatada}`;
        }

        function checkLogin() {
            const graduacao = localStorage.getItem('userGraduacao');
            const nomeGuerra = localStorage.getItem('userNomeGuerra');
            const userInfoEl = document.getElementById('user-info');

            if (graduacao && nomeGuerra) {
                userInfoEl.innerHTML = `
                <p>Bem Vindo(a):</p>
                <p class="user-nome">${graduacao} ${nomeGuerra}</p>
            `;
            } else {
                alert('Sessão expirada ou não iniciada. Redirecionando para a tela de Login.');
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('userGraduacao');
            localStorage.removeItem('userNomeGuerra');
            alert('Logout realizado com sucesso!');
            window.location.href = 'login.html';
        }


        // --- FUNÇÃO OTIMIZADA PARA CONTADORES (GERAL) ---

        /**
         * Função genérica para buscar e exibir a contagem no dashboard.
         * Usada para contagens que retornam apenas um número inteiro (campo 'count').
         */
        function updateCount(url, action, elementId) {
            const currentYear = new Date().getFullYear();
            $(`#${elementId}`).text('...');

            $.ajax({
                url: url,
                type: 'GET',
                data: {
                    action: action,
                    year: currentYear
                },
                dataType: 'json',
                success: function (response) {
                    if (response.status === 'success' && response.count !== undefined) {
                        $(`#${elementId}`).text(response.count);
                    } else {
                        $(`#${elementId}`).text('ERRO');
                        console.error(`Erro ao carregar contagem ${elementId}: ${response.message || 'Erro de comunicação.'}`);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $(`#${elementId}`).text('FALHA');
                    console.error(`Erro na comunicação com o Apps Script (${elementId}):`, textStatus, errorThrown);
                }
            });
        }


        /**
         * FUNÇÃO ESPECÍFICA PARA DROGAS (Soma o Peso Anual)
         * Esta é a função que você corrigiu anteriormente.
         */
        async function atualizarDrogas() {
            if (typeof WEBAPP_URL_DROGAS === 'undefined') {
                console.error("ERRO: A variável 'WEBAPP_URL_DROGAS' não está definida.");
                return;
            }

            // TENTA ENCONTRAR O ELEMENTO ONDE VAI O NÚMERO
            const elementoContador = document.getElementById('numerodrogas');
            // TENTA ENCONTRAR O ELEMENTO ONDE VAI O NOME ("Drogas Apreendidas")
            const elementoTitulo = elementoContador ? elementoContador.previousElementSibling : null;

            if (elementoContador) {
                elementoContador.textContent = '...';
            }

            const currentYear = new Date().getFullYear();
            const url = `${WEBAPP_URL_DROGAS}?action=sumDrogasPeso&year=${currentYear}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    const totalFormatado = String(data.total).replace('.', ',');

                    if (elementoTitulo) {
                        // AÇÃO CRUCIAL: Mudar o título do card para a descrição da soma.
                        elementoTitulo.textContent = 'Peso Total (Ano Atual)';
                    }
                    if (elementoContador) {
                        // Exibe a soma e a unidade (ex: 15,45 Kg)
                        elementoContador.textContent = `${totalFormatado} Kg`;
                    }

                } else {
                    console.error('Erro ao carregar soma de peso de drogas:', data.message);
                    if (elementoContador) {
                        elementoContador.textContent = 'ERRO';
                    }
                }
            } catch (error) {
                console.error('Erro na requisição da soma de drogas:', error);
                if (elementoContador) {
                    elementoContador.textContent = 'FALHA';
                }
            }
        }


        // --- INICIALIZAÇÃO GERAL ---

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializa o Relógio
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);

            // Verifica Login
            checkLogin();

            // Anexa Listener de Logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', logout);
            }

            // CARREGA OS CONTADORES

            // 1. Contagem AIT 
            updateCount(WEBAPP_URL_AIT, 'countAITs', 'numeroait');

            // 2. Contagem Drogas
            atualizarDrogas();

            // 3. Contagem TCO
            updateCount(WEBAPP_URL_TCO, 'countTCOs', 'numerotco');

            // 4. Contagem Materiais Apreendidos (NOVO)
            if (WEBAPP_URL_MATERIAIS && WEBAPP_URL_MATERIAIS !== 'SUA_URL_DO_WEBAPP_MATERIAIS_AQUI') {
                // Usa a ação 'countMateriais' que implementamos para subtrair os 'DEVOLVIDO'
                updateCount(WEBAPP_URL_MATERIAIS, 'countMateriais', 'numeromateriais');
            } else {
                // Alerta visual para o usuário configurar a URL se o placeholder estiver lá
                $('#numeromateriais').text('Set URL'); 
            }
        });
    </script>

</html>