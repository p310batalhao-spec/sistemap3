<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Sistema de Gerenciamento P3</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div> <!--termina cabecalhotexto-->
        </div><!--termina header-info-left-->

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="user-notification">
                <div class="exibirusuario" id="user-info"></div>
                <div class="notification-container">
                    <span class="material-icons" id="bell-icon">notifications</span>
                    <span class="badge" id="notif-count" style="display: none;">0</span>
                    <div class="notif-dropdown" id="notif-dropdown">
                        <div class="notif-header">Notificações</div>
                        <div id="notif-items">
                            <p class="empty-msg">Nenhuma notificação nova</p>
                        </div><!--termina notif-items-->
                    </div><!--termina notif-dropdown-->
                </div><!--termina notification-container-->
            </div><!--termina user-notification-->
        </div><!--termina header-info-right-->
    </header><!--termina header-->

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html" class="active">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->
        <main>
            <div class="saudacao">
                <h2>Bem-vindo ao Sistema de Gerenciamento P3</h2>
                <p>Utilize o menu lateral para navegar entre as seções do sistema.</p>
            </div>

            <section class="dashboard">
                <a href="mvi.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/skull.png" alt="skull" />
                    <p>MVI - Mortes Violentas</p>
                    <p id="numeromvi" class="numero">--</p>
                </a><!--termina o mvi-->

                <a href="cvp.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/robber.png" alt="robber" />
                    <p>CVP - Crimes Contra o Patrimônio</p>
                    <p id="numerocvp" class="numero">--</p>
                </a>
                <a href="tco.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/morale.png" alt="morale" />
                    <p>TCO - Termos Circunstanciados</p>
                    <p id="numerotco" class="numero">--</p>
                </a> <!--termina o tco-->

                <a href="violenciadomestica.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/windows/32/hand.png" alt="hand" />
                    <p>Violência Doméstica</p>
                    <p id="numeroviolenciadomestica" class="numero">--</p>
                </a> <!--termina violencia domestica-->

                <div class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/gun.png" alt="gun" />
                    <p>Armas Apreenndidas</p>
                    <p id="armasapreendidas" class="numero">--</p>
                </div> <!--termina armas apreendidas-->

                <a href="drogas.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/marijuana-leaf.png"
                        alt="Drogas Apreendidas" />
                    <p>Drogas Apreendidas</p>
                    <p id="numerodrogas" class="numero">--</p>
                </a> <!--termina drogas apreendidas-->

                <a href="ait.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios-glyphs/30/policeman-male.png"
                        alt="policeman-male" />
                    <p>Infrações de Trânsito</p>
                    <p class="numero" id="numeroait">50</p>
                </a> <!--termina o ait-->

                <a href="materiais.html" class="btn">
                    <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                    <p>Materiais Apreendidos</p>
                    <p class="numero" id="numeromateriais">--</p>
                </a><!--termina materiais apreendidos-->

                <a href="mandado.html" class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-outlines-amoghdesign/32/external-balance-law-crime-and-justice-outlines-amoghdesign.png"
                        alt="external-balance-law-crime-and-justice-outlines-amoghdesign" />
                    <p>Cumprimentos de Mandados</p>
                    <p id="numeromandados" class="numero">--</p>
                </a><!--termina mandados-->
                <a href="perturbacao.html" class="btn">
                    <img width="50" height="50"
                        src="https://img.icons8.com/external-xnimrodx-lineal-xnimrodx/64/external-boombox-music-xnimrodx-lineal-xnimrodx.png"
                        alt="external-boombox-music-xnimrodx-lineal-xnimrodx" />
                    <p>Perturbação do Sossego</p>
                    <p id="numeroperturbacaodosossego" class="numero">--</p>
                </a><!--termina perturbacao-->


            </section>
        </main>
    </section>

    <footer>
        <div>
            <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        // ********************************************************************
        // ** CONFIGURAÇÕES DE URLs **
        // ********************************************************************
        const WEBAPP_URL_AIT = 'https://script.google.com/macros/s/AKfycbyNpjC9Ul4XRllFSciCj6hA62u74K8VIdXo1ecND-VCg1RiJCETqCWnrKKNN3bQtChOTg/exec';
        const WEBAPP_URL_DROGAS = 'https://script.google.com/macros/s/AKfycbzw3yzJEf5hC7DtE_1P8OTvopqigWdVOilONhOMiii-2wLAHXO8v4uwDDD0895GzsEZQg/exec';
        const WEBAPP_URL_TCO = 'https://script.google.com/macros/s/AKfycbxXQhiX_EOskIWziWh2vG5UvuaOKBmv-7JIhBcghLlEiBpBEUtUV8Wn9M2Wk6kLtbgf/exec';
        const WEBAPP_URL_MATERIAIS = 'https://script.google.com/macros/s/AKfycbyftHcIS_0isNZsUsWrNBgOItkKeLMJbrhnpPz3zj4m0-5Vczkf2xDKrdpI-dMsI-9mQg/exec';
        const API_URL_MVI = "https://script.google.com/macros/s/AKfycbzpoyFungNK4VL99YrPj_jCF0GwBtUF0w8wXLhZxgbNUVbGbU3CxLS0n6-jOiqfASCJTA/exec";
        const WEBAPP_URL_PERTURBACAO = "https://script.google.com/macros/s/AKfycbwpkufWkoQ483xA3t8UGgf-q7Je3r3pXrRMcN9v_3RZQA9xjnEaocDa-9jsTu_c7P37/exec";
        const WEBAPP_URL_CVP = 'https://script.google.com/macros/s/AKfycbzgC94-IDT31Mzmz8T1u3yvuHvM3Y73WRqjEeWIG3cKxNHDACMH1rwRSNxiX3APUTWi/exec';
        const WEBAPP_URL_VD = 'https://script.google.com/macros/s/AKfycbyyqS93ST2mawBpEEjmbgMHYBhh7nMJXv8_yTelXtNxZ2BhS03KfAlBGqpTjXCp3scbQQ/exec';
        // --- FUNÇÕES DE UTILIDADE ---

        function atualizarRelogio() {
            const agora = new Date();
            const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
            const dataFormatada = agora.toLocaleDateString('pt-BR', opcoesData);
            const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('relogio').innerHTML = `${dataFormatada} <br> ${horaFormatada}`;
        }

        function checkLogin() {
            const graduacao = localStorage.getItem('userGraduacao');
            const nomeGuerra = localStorage.getItem('userNomeGuerra');
            const userInfoEl = document.getElementById('user-info');

            if (graduacao && nomeGuerra) {
                userInfoEl.innerHTML = `<p>Bem Vindo(a):</p><p class="user-nome">${graduacao} ${nomeGuerra}</p>`;
            } else {
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('userGraduacao');
            localStorage.removeItem('userNomeGuerra');
            window.location.href = 'login.html';
        }

        // --- FUNÇÃO DE CONTAGEM UNIFICADA (Resolve Erro de Comunicação) ---

        function updateCount(url, action, elementId) {
            const currentYear = new Date().getFullYear();
            const $el = $(`#${elementId}`);
            $el.text('...');

            $.ajax({
                url: url,
                type: 'GET',
                data: { action: action, year: currentYear },
                dataType: 'json',
                success: function (response) {
                    // Suporte para response.count (padrão) ou response.total (usado no MVI)
                    let valor = response.count !== undefined ? response.count : response.total;

                    if (valor !== undefined) {
                        $el.text(valor);
                    } else {
                        $el.text('0');
                        console.warn(`Resposta sem contagem para ${elementId}:`, response);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $el.text('!');
                    console.error(`Erro na comunicação (${elementId}):`, textStatus, errorThrown);
                }
            });
        }

        // --- FUNÇÃO ESPECÍFICA PARA DROGAS (Soma de Peso) ---
        async function atualizarDrogas() {
            const $el = $('#numerodrogas');
            if (!$el.length) return;
            $el.text('...');

            const currentYear = new Date().getFullYear();
            try {
                const response = await fetch(`${WEBAPP_URL_DROGAS}?action=sumDrogasPeso&year=${currentYear}`);
                const data = await response.json();
                if (data.status === 'success') {
                    const totalFormatado = String(data.total).replace('.', ',');
                    $el.text(`${totalFormatado} Kg`);
                } else { $el.text('0 Kg'); }
            } catch (error) {
                $el.text('Erro');
                console.error('Erro Drogas:', error);
            }
        }

        // --- NOTIFICAÇÕES ---
        let lastCountAIT = localStorage.getItem('lastCountAIT') || 0;

        function checkNewNotifications() {
            fetch(WEBAPP_URL_AIT + "?action=countAITs")
                .then(res => res.json())
                .then(data => {
                    const currentCount = data.count || data.numeroait;
                    if (currentCount > lastCountAIT && lastCountAIT != 0) {
                        const novos = currentCount - lastCountAIT;
                        addNotification(`Existem ${novos} novas inclusões de AIT.`);
                        const badge = document.getElementById('notif-count');
                        badge.innerText = novos;
                        badge.style.display = 'block';
                    }
                }).catch(e => console.log("Erro Notificações:", e));
        }

        function addNotification(text) {
            const container = document.getElementById('notif-items');
            const emptyMsg = container.querySelector('.empty-msg');
            if (emptyMsg) emptyMsg.remove();

            const item = document.createElement('div');
            item.className = 'notif-item';
            item.innerHTML = `<strong>Novo Registro:</strong><br>${text}`;
            container.prepend(item);
        }

        document.getElementById('bell-icon').addEventListener('click', () => {
            const dropdown = document.getElementById('notif-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            document.getElementById('notif-count').style.display = 'none';
        });

        // --- INICIALIZAÇÃO GERAL ---

        document.addEventListener('DOMContentLoaded', function () {
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            checkLogin();

            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) btnLogout.addEventListener('click', logout);

            // 1. AIT
            updateCount(WEBAPP_URL_AIT, 'countAITs', 'numeroait');

            // 2. Drogas
            atualizarDrogas();

            // 3. TCO
            updateCount(WEBAPP_URL_TCO, 'countTCOs', 'numerotco');

            // 4. MVI (Homicídios) - Agora via updateCount
            updateCount(API_URL_MVI, 'countHomicidios', 'numeromvi');

            // 5. Materiais Apreendidos
            updateCount(WEBAPP_URL_MATERIAIS, 'countMateriais', 'numeromateriais');

            // 6. Perturbação do Sossego
            updateCount(WEBAPP_URL_PERTURBACAO, 'countPerturbacao', 'numeroperturbacaodosossego');

            // 7. CVP (NOVO) - contagem CVP:
            updateCount(WEBAPP_URL_CVP, 'countCVPs', 'numerocvp');

            // 8. VIOLENCIA DOMESTICA
            updateCount(WEBAPP_URL_VD, 'countVD', 'numeroviolenciadomestica')

            // Inicia monitoramento de notificações
            setInterval(checkNewNotifications, 60000);
        });
    </script>


</html>