<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - MVI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="stylesmvi.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->

        <main>
            <div class="saudacao">
                <h2>Crimes Violentos Letais e Intensionais</h2>
                <p>Homicídio, Tentativa de Homicídio, Infanticídio, Feminicídio</p>
            </div>
            <div class="TabelaEventos">
                <h3>Cadastro de CVLI</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo CVLI
                    </button>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div>

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="N° DO BOU">N° BOU</option>
                        <option value="DATA">Data</option>
                        <option value="CATEGORIA">Categoria</option>
                        <option value="ESAJ">ESAJ</option>
                        <option value="STATUS">Status</option>
                        <option value="LOCAL">Local</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor..." style="display: block;">

                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>
                </div>
                <div class="container-tabela">
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>Nº OCORRÊNCIA</th>
                                <th>DATA</th>
                                <th>HORA</th>
                                <th>SOLICITANTE</th>
                                <th>TELEFONE</th>
                                <th>LOGRADOURO</th>
                                <th>BAIRRO</th>
                                <th>CIDADE</th>
                                <th>PONTO REF.</th>
                                <th>LATITUDE</th>
                                <th>LONGITUDE</th>
                                <th>TIPIFICAÇÃO</th>
                                <th>ESTABELECIMENTO</th>
                                <th>SOLUÇÃO</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div><!--termina container-tabela-->
            </div><!--termina tabelaEventos-->
            <div id="overlay-sidebar" class="overlay-sidebar"></div>

            <form class="sidbarform" id="form-materiais">
                <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
                <h4>Cadastro de Material Apreendido</h4>

                <input type="hidden" id="form-id" name="ID_OCORRENCIA">

                <div class="formulario-scroll">
                    <div class="formulario">
                        <p>Nº OCORRÊNCIA</p>
                        <input type="text" name="NUMEROOCORRENCIA" id="NUMEROOCORRENCIA">
                    </div>
                    <div class="formulario">
                        <p>DATA</p>
                        <input type="date" name="data" id="data">
                    </div>
                    <div class="formulario">
                        <p>HORA</p>
                        <input type="time" name="HORA" id="HORA">
                    </div>
                    <div class="formulario">
                        <p>SOLICITANTE</p>
                        <input type="text" name="SOLICITANTE" id="SOLICITANTE">
                    </div>
                    <div class="formulario">
                        <p>SOLICITANTE (TELEFONE)</p>
                        <input type="tel" name="SOLICITANTETELEFONE" id="SOLICITANTETELEFONE">
                    </div>
                    <div class="formulario">
                        <p>SOLUÇÃO</p>
                        <input type="text" name="SOLUÇÃO" id="SOLUÇÃO">
                    </div>
                    <div class="formulario">
                        <p>LOGRADOURO</p>
                        <input type="text" name="LOGRADOURO" id="LOGRADOURO">
                    </div>
                    <div class="formulario">
                        <p>BAIRRO</p>
                        <input type="text" name="BAIRRO" id="BAIRRO">
                    </div>
                    <div class="formulario">
                        <p>CIDADE</p>
                        <select name="CIDADE" id="CIDADE">
                            <option value="">Selecione a Cidade</option>
                            <option value="Belém">Belém</option>
                            <option value="Cacimbinhas">Cacimbinhas</option>
                            <option value="Estrela de Alagoas">Estrela de Alagoas</option>
                            <option value="Igaci">Igaci</option>
                            <option value="Mar Vermelho">Mar Vermelho</option>
                            <option value="Maribondo">Maribondo</option>
                            <option value="Paulo Jacinto">Paulo Jacinto</option>
                            <option value="Palmeira dos Índios">Palmeira dos Índios</option>
                            <option value="Quebrangulo">Quebrangulo</option>
                            <option value="Tanque D'arca">Tanque D'Arca</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>PONTO DE REFERENCIA</p>
                        <input type="text" name="PONTO_REF" id="PONTO_REF">
                    </div>
                    <div class="formulario">
                        <p>LATITUDE</p>
                        <input type="text" name="LATITUDE" id="LATITUDE">
                    </div>
                    <div class="formulario">
                        <p>LONGITUDE</p>
                        <input type="text" name="LONGITUDE" id="LONGITUDE">
                    </div>
                    <div class="formulario">
                        <p>TIPIFICAÇÃO GERAL</p>
                        <select name="TIPIFICAÇÃO GERAL" id="TIPIFICAÇÃO GERAL">
                            <option value="">Selecione a Tipificação</option>
                            <option value="HOMICÍDIO">HOMICÍDIO</option>
                            <option value="FEMINICÍDIO">FEMINICÍDIO</option>
                            <option value="INFANTICÍDIO">IFANTICÍDIO</option>
                            <option value="TENTATIVA DE HOMICÍDIO">TENTATIVA DE HOMICÍDIO</option>
                            <option value="TENTATIVA DE FEMINICÍDIO">TENTATIVA DE FEMINICÍDIO</option>
                            <option value="TENTATIVA DE INFANTICÍDIO">TENTATIVA DE INFANTICÍDIO</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>ESTABELECIMENTO</p>
                        <input type="text" name="ESTABELECIMENTO" id="ESTABELECIMENTO">
                    </div>
                    <div class="formulario">
                        <p>SOLUÇÃO DA OCORRÊNCIA</p>
                        <input type="text" name="SOLUÇÃO DA OCORRÊNCIA" id="SOLUÇÃO DA OCORRÊCIA">
                    </div>
                </div><!--termina formulario-scroll-->
                <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                    style="width: 100%; padding: 15px; margin-top: 20px;">
                    SALVAR DADOS
                </button>
            </form><!--termina sidebarform-->

        </main>
    </section>
</body>
<footer>
    <div>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </div>
</footer>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzpoyFungNK4VL99YrPj_jCF0GwBtUF0w8wXLhZxgbNUVbGbU3CxLS0n6-jOiqfASCJTA/exec";
    const sidebar = document.querySelector('.sidbarform');
    const overlay = document.getElementById('overlay-sidebar');
    const form = document.getElementById('form-materiais');

    // --- CONTROLE DE ABERTURA/FECHAMENTO ---
    document.getElementById('btn-adicionar-cadastro').addEventListener('click', () => {
        form.reset();
        if(document.getElementById('form-id')) document.getElementById('form-id').value = "";
        sidebar.classList.add('active');
        overlay.style.display = 'block';
    });

    const fecharSidebar = () => {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
        form.reset();
    };

    document.getElementById('btn-fechar-sidebar').addEventListener('click', fecharSidebar);
    overlay.addEventListener('click', fecharSidebar);

    // --- CARREGAR DADOS ---
    async function carregarDados() {
        try {
            const res = await fetch(API_URL);
            const dados = await res.json();
            const tbody = document.querySelector('#tabela-materiais tbody');
            tbody.innerHTML = "";

            dados.reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item['Nº Ocorrência'] || ""}</td>
                    <td>${item['DATA'] || ""}</td>
                    <td>${item['HORA'] || ""}</td>
                    <td>${item['Solicitante (Nome)'] || ""}</td>
                    <td>${item['Solicitante (Telefone)'] || ""}</td>
                    <td>${item['Logradouro'] || ""}</td>
                    <td>${item['Bairro'] || ""}</td>
                    <td>${item['Cidade'] || ""}</td>
                    <td>${item['Ponto de Referência'] || ""}</td>
                    <td>${item['Latitude (Abertura de Ocor.)'] || ""}</td>
                    <td>${item['Longitude (Abertura de Ocor.)'] || ""}</td>
                    <td>${item['Tipificação Geral'] || ""}</td>
                    <td>${item['Estabelecimento'] || ""}</td>
                    <td>${item['Solução da Ocorrência'] || ""}</td>
                    <td id="acao-${item['Nº Ocorrência']}"></td>
                `;
                
                // Botão de editar criado de forma segura
                const btnEditar = document.createElement('button');
                btnEditar.className = 'btn-editar';
                btnEditar.innerText = 'EDITAR';
                btnEditar.onclick = () => preencherParaEditar(item);
                
                tbody.appendChild(tr);
                tr.querySelector(`[id="acao-${item['Nº Ocorrência']}"]`).appendChild(btnEditar);
            });
            document.getElementById('mensagem-carregamento').style.display = 'none';
        } catch (e) {
            console.error("Erro ao carregar:", e);
        }
    }

    // --- PREENCHER PARA EDITAR (COM PROTEÇÃO CONTRA ERROS) ---
    window.preencherParaEditar = (item) => {
        sidebar.classList.add('active');
        overlay.style.display = 'block';

        // Função interna para preencher apenas se o ID existir no HTML
        const preencher = (id, valor) => {
            const campo = document.getElementById(id);
            if (campo) {
                campo.value = valor || "";
            } else {
                console.warn("Campo não encontrado no HTML: " + id);
            }
        };

        // Mapeamento dos campos conforme os IDs do seu formulário no mvi.html
        preencher('form-id', item['Nº Ocorrência']);
        preencher('DATA', converterDataParaInput(item['DATA']));
        preencher('HORA', item['HORA']);
        preencher('SOLICITANTE_NOME', item['Solicitante (Nome)']);
        preencher('SOLICITANTE_FONE', item['Solicitante (Telefone)']);
        preencher('LOGRADOURO', item['Logradouro']);
        preencher('BAIRRO', item['Bairro']);
        preencher('CIDADE', item['Cidade']);
        preencher('PONTO_REF', item['Ponto de Referência']);
        preencher('LATITUDE', item['Latitude (Abertura de Ocor.)']);
        preencher('LONGITUDE', item['Longitude (Abertura de Ocor.)']);
        preencher('TIPIFICACAO_GERAL', item['Tipificação Geral']);
        preencher('ESTABELECIMENTO', item['Estabelecimento']);
        preencher('SOLUCAO_OCORRENCIA', item['Solução da Ocorrência']);
    };

    // --- SALVAR DADOS ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-salvar-form');
        btn.innerText = "Salvando...";
        btn.disabled = true;
        
        const formData = new FormData(form);
        const objetoDados = {
            ID_OCORRENCIA: document.getElementById('form-id') ? document.getElementById('form-id').value : "",
            DATA: formData.get('DATA'),
            HORA: formData.get('HORA'),
            SOLICITANTE_NOME: formData.get('SOLICITANTE_NOME'),
            SOLICITANTE_FONE: formData.get('SOLICITANTE_FONE'),
            LOGRADOURO: formData.get('LOGRADOURO'),
            BAIRRO: formData.get('BAIRRO'),
            CIDADE: formData.get('CIDADE'),
            PONTO_REF: formData.get('PONTO_REF'),
            LATITUDE: formData.get('LATITUDE'),
            LONGITUDE: formData.get('LONGITUDE'),
            TIPIFICACAO_GERAL: formData.get('TIPIFICACAO_GERAL'),
            ESTABELECIMENTO: formData.get('ESTABELECIMENTO'),
            SOLUCAO_OCORRENCIA: formData.get('SOLUCAO_OCORRENCIA')
        };

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(objetoDados),
                redirect: "follow"
            });
            alert("Sucesso!");
            fecharSidebar();
            carregarDados();
        } catch (err) {
            alert("Erro ao salvar: " + err);
        } finally {
            btn.innerText = "SALVAR DADOS";
            btn.disabled = false;
        }
    });

    function converterDataParaInput(d) {
        if(!d || !d.includes('/')) return d;
        const p = d.split('/');
        return `${p[2]}-${p[1]}-${p[0]}`;
    }

    // --- FUNÇÕES DE INTERFACE (RELÓGIO E LOGIN) ---
    function atualizarRelogio() {
        const agora = new Date();
        const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
        const dataFormatada = agora.toLocaleDateString('pt-BR', opcoesData);
        const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('relogio').innerHTML = `${dataFormatada} <br> ${horaFormatada}`;
    }
    setInterval(atualizarRelogio, 1000);

    function checkLogin() {
        const graduacao = localStorage.getItem('userGraduacao');
        const nomeGuerra = localStorage.getItem('userNomeGuerra');
        const userInfoEl = document.getElementById('user-info');
        if (graduacao && nomeGuerra) {
            userInfoEl.innerHTML = `<p>Bem Vindo(a):</p><p class="user-nome">${graduacao} ${nomeGuerra}</p>`;
        } else {
            window.location.href = 'login.html';
        }
    }

    function logout() {
        localStorage.removeItem('userGraduacao');
        localStorage.removeItem('userNomeGuerra');
        window.location.href = 'login.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkLogin();
        carregarDados();
        atualizarRelogio();
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) btnLogout.addEventListener('click', logout);
    });
    
</script>