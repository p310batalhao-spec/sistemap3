<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - MANDADOS</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="stylesmandado.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png"
                    alt="performance-macbook" />
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->
        <main>
            <div class="saudacao">
                <h2>CUMPRIMENTOS DE MANDADOS</h2>
                <p>PRISÃO, BUSCA E APREENSÃO, RESTITUIÇÃO E REINTEGRAÇÃO</p>
            </div>
            <div class="TabelaEventos">
                <h3>Cadastro de Mandados</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo Mandado
                    </button>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div>

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="DATA">DATA</option>
                        <option value="HORA">HORA</option>
                        <option value="SOLICITANTE">SOLICITANTE</option>
                        <option value="TELEFONE">TELEFONE</option>
                        <option value="LOGRADOURO">LOGRADOURO</option>
                        <option value="BAIRRO">BAIRRO</option>
                        <option value="CIDADE">CIDADE</option>
                        <option value="PONTO REF">PONTO REF</option>
                        <option value="LATITUDE">LATITUDE</option>
                        <option value="LONGITUDE">LONGITUDE</option>
                        <option value="TIPIFICACAO_GERAL">TIPIFICACAO_GERAL</option>
                        <option value="ESTABELECIMENTO">ESTABELECIMENTO</option>
                        <option value="SOLUÇÃO">SOLUÇÃO</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor..." style="display: block;">

                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>
                </div>
                <div class="tabela-container">
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>Nº OCORRÊNCIA</th>
                                <th>DATA</th>
                                <th>HORA</th>
                                <th>SOLICITANTE</th>
                                <th>TELEFONE</th>
                                <th>LOGRADOURO</th>
                                <th>BAIRRO</th>
                                <th>CIDADE</th>
                                <th>PONTO REF.</th>
                                <th>LATITUDE</th>
                                <th>LONGITUDE</th>
                                <th>TIPIFICAÇÃO</th>
                                <th>ESTABELECIMENTO</th>
                                <th>SOLUÇÃO</th>
                                <th>AÇÕES</th>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
                        <div id="overlay-sidebar" class="overlay-sidebar"></div>

            <form class="sidbarform" id="form-materiais">
                <button type="button" class="btn-fechar" id="btn-fechar-sidebar">FECHAR / CANCELAR</button>
                <h4>Cadastro de Material Apreendido</h4>

                <input type="hidden" id="form-id" name="ID_OCORRENCIA">

                <div class="formulario-scroll">
                    <div class="formulario">
                        <p>Nº OCORRÊNCIA</p>
                        <input type="text" name="NUMEROOCORRENCIA" id="NUMEROOCORRENCIA">
                    </div>
                    <div class="formulario">
                        <p>DATA</p>
                        <input type="date" name="data" id="data">
                    </div>
                    <div class="formulario">
                        <p>HORA</p>
                        <input type="time" name="HORA" id="HORA">
                    </div>
                    <div class="formulario">
                        <p>SOLICITANTE</p>
                        <input type="text" name="SOLICITANTE" id="SOLICITANTE">
                    </div>
                    <div class="formulario">
                        <p>SOLICITANTE (TELEFONE)</p>
                        <input type="tel" name="SOLICITANTETELEFONE" id="SOLICITANTETELEFONE">
                    </div>
                    <div class="formulario">
                        <p>SOLUÇÃO</p>
                        <input type="text" name="SOLUÇÃO" id="SOLUÇÃO">
                    </div>
                    <div class="formulario">
                        <p>LOGRADOURO</p>
                        <input type="text" name="LOGRADOURO" id="LOGRADOURO">
                    </div>
                    <div class="formulario">
                        <p>BAIRRO</p>
                        <input type="text" name="BAIRRO" id="BAIRRO">
                    </div>
                    <div class="formulario">
                        <p>CIDADE</p>
                        <select name="CIDADE" id="CIDADE">
                            <option value="">Selecione a Cidade</option>
                            <option value="Belém">Belém</option>
                            <option value="Cacimbinhas">Cacimbinhas</option>
                            <option value="Estrela de Alagoas">Estrela de Alagoas</option>
                            <option value="Igaci">Igaci</option>
                            <option value="Mar Vermelho">Mar Vermelho</option>
                            <option value="Maribondo">Maribondo</option>
                            <option value="Paulo Jacinto">Paulo Jacinto</option>
                            <option value="Palmeira dos Índios">Palmeira dos Índios</option>
                            <option value="Quebrangulo">Quebrangulo</option>
                            <option value="Tanque D'arca">Tanque D'Arca</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>PONTO DE REFERENCIA</p>
                        <input type="text" name="PONTO_REF" id="PONTO_REF">
                    </div>
                    <div class="formulario">
                        <p>LATITUDE</p>
                        <input type="text" name="LATITUDE" id="LATITUDE">
                    </div>
                    <div class="formulario">
                        <p>LONGITUDE</p>
                        <input type="text" name="LONGITUDE" id="LONGITUDE">
                    </div>
                    <div class="formulario">
                        <p>TIPIFICAÇÃO GERAL</p>
                        <select name="TIPIFICAÇÃO GERAL" id="TIPIFICAÇÃO GERAL">
                            <option value="">Selecione a Tipificação</option>
                            <option value="CUMPRIMENTO DE MANDADO JUDICIAL | OCORRÊNCIA SEM ILICITUDE">CUMPRIMENTO DE MANDADO JUDICIAL | OCORRÊNCIA SEM ILICITUDE</option>
                        </select>
                    </div>
                    <div class="formulario">
                        <p>ESTABELECIMENTO</p>
                        <input type="text" name="ESTABELECIMENTO" id="ESTABELECIMENTO">
                    </div>
                    <div class="formulario">
                        <p>SOLUÇÃO DA OCORRÊNCIA</p>
                        <input type="text" name="SOLUÇÃO DA OCORRÊNCIA" id="SOLUÇÃO DA OCORRÊCIA">
                    </div>
                </div><!--termina formulario-scroll-->
                <button type="submit" id="btn-salvar-form" class="btn-salvar-evento"
                    style="width: 100%; padding: 15px; margin-top: 20px;">
                    SALVAR DADOS
                </button>
            </form><!--termina sidebarform-->
        </main>
    </section>
</body>
<footer>
    <div>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </div>
</footer>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzpY_8r8s8gPu-yEHa4jJEONTrYZsGwOj4OA26E9y2FO0ejQQkk3-wjWcN88QDUvLNh/exec"; 
    
    const sidebar = document.querySelector('.sidbarform');
    const overlay = document.getElementById('overlay-sidebar');
    const form = document.getElementById('form-materiais');

    // Funções de Interface
    function atualizarRelogio() {
        const agora = new Date();
        const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
        document.getElementById('relogio').innerHTML = `${agora.toLocaleDateString('pt-BR', opcoesData)} <br> ${agora.toLocaleTimeString('pt-BR')}`;
    }

    // Controle Sidebar
    const fecharSidebar = () => {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
        form.reset();
        document.getElementById('form-id').value = "";
    };

    document.getElementById('btn-adicionar-cadastro').addEventListener('click', () => {
        form.reset();
        document.getElementById('form-id').value = ""; 
        sidebar.classList.add('active');
        overlay.style.display = 'block';
    });

    document.getElementById('btn-fechar-sidebar').addEventListener('click', fecharSidebar);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) fecharSidebar(); });

    // Listar Tabela
    async function carregarDados() {
        try {
            const res = await fetch(API_URL);
            const dados = await res.json();
            const tbody = document.querySelector('#tabela-materiais tbody');
            tbody.innerHTML = "";

            dados.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item['Nº Ocorrência'] || ""}</td>
                    <td>${item['DATA'] || ""}</td>
                    <td>${item['HORA'] || ""}</td>
                    <td>${item['Solicitante (Nome)'] || ""}</td>
                    <td>${item['Solicitante (Telefone)'] || ""}</td>
                    <td>${item['Logradouro'] || ""}</td>
                    <td>${item['Bairro'] || ""}</td>
                    <td>${item['Cidade'] || ""}</td>
                    <td>${item['Ponto de Referência'] || ""}</td>
                    <td>${item['Latitude (Abertura de Ocor.)'] || ""}</td>
                    <td>${item['Longitude (Abertura de Ocor.)'] || ""}</td>
                    <td>${item['Tipificação Geral'] || ""}</td>
                    <td>${item['Estabelecimento'] || ""}</td>
                    <td>${item['Solução da Ocorrência'] || ""}</td>
                    <td><button class="btn-editar">EDITAR</button></td>
                `;
                tr.querySelector('.btn-editar').onclick = () => preencherParaEditar(item);
                tbody.appendChild(tr);
            });
            document.getElementById('mensagem-carregamento').style.display = 'none';
        } catch (e) { console.error(e); }
    }

    // Editar
    window.preencherParaEditar = (item) => {
        sidebar.classList.add('active');
        overlay.style.display = 'block';
        document.getElementById('form-id').value = item['Nº Ocorrência'];
        document.getElementById('NUMEROOCORRENCIA').value = item['Nº Ocorrência'];
        document.getElementById('data').value = converterDataParaInput(item['DATA']);
        document.getElementById('HORA').value = item['HORA'];
        document.getElementById('SOLICITANTE').value = item['Solicitante (Nome)'];
        document.getElementById('SOLICITANTETELEFONE').value = item['Solicitante (Telefone)'];
        document.getElementById('LOGRADOURO').value = item['Logradouro'];
        document.getElementById('BAIRRO').value = item['Bairro'];
        document.getElementById('CIDADE').value = item['Cidade'];
        document.getElementById('PONTO_REF').value = item['Ponto de Referência'];
        document.getElementById('LATITUDE').value = item['Latitude (Abertura de Ocor.)'];
        document.getElementById('LONGITUDE').value = item['Longitude (Abertura de Ocor.)'];
        document.getElementById('TIPIFICAÇÃO GERAL').value = item['Tipificação Geral'];
        document.getElementById('ESTABELECIMENTO').value = item['Estabelecimento'];
        document.getElementById('SOLUÇÃO DA OCORRÊCIA').value = item['Solução da Ocorrência'];
    };

    // Salvar
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-salvar-form');
        btn.innerText = "Salvando..."; btn.disabled = true;

        const dados = {
            ID_OCORRENCIA: document.getElementById('form-id').value,
            DATA: document.getElementById('data').value,
            HORA: document.getElementById('HORA').value,
            SOLICITANTE_NOME: document.getElementById('SOLICITANTE').value,
            SOLICITANTE_FONE: document.getElementById('SOLICITANTETELEFONE').value,
            LOGRADOURO: document.getElementById('LOGRADOURO').value,
            BAIRRO: document.getElementById('BAIRRO').value,
            CIDADE: document.getElementById('CIDADE').value,
            PONTO_REF: document.getElementById('PONTO_REF').value,
            LATITUDE: document.getElementById('LATITUDE').value,
            LONGITUDE: document.getElementById('LONGITUDE').value,
            TIPIFICACAO: document.getElementById('TIPIFICAÇÃO GERAL').value,
            ESTABELECIMENTO: document.getElementById('ESTABELECIMENTO').value,
            SOLUCAO_FINAL: document.getElementById('SOLUÇÃO DA OCORRÊCIA').value
        };

        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) });
            alert("Mandado salvo com sucesso!");
            fecharSidebar(); carregarDados();
        } catch (err) { alert("Erro ao salvar."); }
        finally { btn.innerText = "SALVAR DADOS"; btn.disabled = false; }
    });

    function converterDataParaInput(d) {
        if(!d || !d.includes('/')) return d;
        const p = d.split('/');
        return `${p[2]}-${p[1]}-${p[0]}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        carregarDados();
        setInterval(atualizarRelogio, 1000);
    });
</script>