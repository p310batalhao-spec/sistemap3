<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - TCO</title>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
 <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

         <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info">
            </div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a>
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a>
            <a href="materiais.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a>
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a>
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a>
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button>
        </nav>

        <main>
            <div class="saudacao">
                <h2>Termos Circunstanciados de Ocorrências</h2>
                <p>Gerenciamento de TCO</p>
            </div>
            <div class="TabelaEventos">
                <h3>Cadastro de TCO</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo TCO
                    </button>
                    <button id="btn-imprimir">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/print--v1.png"
                            alt="Imprimir" style="filter: brightness(0) invert(1);" />
                        Imprimir Tabela
                    </button>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div>

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="Nº Ocorrência">Nº Ocorrência</option>
                        <option value="DATA">Data</option>
                        <option value="OPERADOR CAPA">Operador Capa</option>
                        <option value="Movimentação">Movimentação</option>
                        <option value="Tipicidade Geral">Tipicidade Geral</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor..." style="display: block;">

                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>
                </div>
                <div class="tabela-container">
                    <table id="tabela-tco"> 
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Dia da Semana</th>
                                <th>Mês</th>
                                <th>Hora</th>
                                <th>Nº Ocorrência</th>
                                <th>DATA</th>
                                <th>SERVIÇO</th>
                                <th>OPERADOR CAPA</th>
                                <th>SISDOC</th>
                                <th>Tipicidade Geral</th>
                                <th>Movimentação</th>
                                <th>OBS:</th>
                                <th>Material Apreendido</th>
                                <th>Data Envio</th>
                                <th>LocalE-SAJ</th>
                                <th>PETICIONADOR</th>
                                <th>Endereço</th>
                                <th>Vistoriou?</th>
                                <th>NUMERO_LACRE</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </section>
</body>
<footer>
    <div>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </div>
</footer>
<script>
    // URL de implantação do seu Google Apps Script (ATUALIZE ESTA VARIÁVEL)
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxXQhiX_EOskIWziWh2vG5UvuaOKBmv-7JIhBcghLlEiBpBEUtUV8Wn9M2Wk6kLtbgf/exec'; 

    // Chaves de todas as colunas da planilha (DEVE SER A MESMA ORDEM DO HEADERS_TCO no Code.gs)
    const chavesTCO = [
        'ID', 'Dia da Semana', 'Mês', 'Hora', 'Nº Ocorrência', 'DATA', 'SERVIÇO', 'OPERADOR CAPA', 
        'SISDOC', 'Tipicidade Geral', 'Movimentação', 'OBS:', 'Material Apreendido', 'Data Envio', 
        'LocalE-SAJ', 'PETICIONADOR', 'Endereço', 'Vistoriou?', 'NUMERO_LACRE'
    ];

    // Colunas que o usuário pode editar diretamente.
    const chavesEditaveis = [
        'Dia da Semana', 'Mês', 'Hora', 'Nº Ocorrência', 'DATA', 'SERVIÇO', 'OPERADOR CAPA', 
        'SISDOC', 'Tipicidade Geral', 'Movimentação', 'OBS:', 'Material Apreendido', 'Data Envio', 
        'LocalE-SAJ', 'PETICIONADOR', 'Endereço', 'Vistoriou?', 'NUMERO_LACRE'
    ];

    // Opções para as colunas com menu suspenso (dropdown)
    const DROPDOWN_OPTIONS = {
        'Movimentação': ['Protocolado', 'Em Diligência', 'Encaminhado ao Juizado', 'Arquivado'],
        'Vistoriou?': ['Sim', 'Não']
    };

    // Armazenamento local dos dados (para filtragem)
    let dadosTCO = [];
    const tabelaBody = document.querySelector('#tabela-tco tbody');
    const msgCarregamento = document.getElementById('mensagem-carregamento');

    /**
     * FUNÇÃO AUXILIAR: Mapeia o valor da Movimentação para a classe CSS
     */
    function getStatusClass(statusValue) {
        if (!statusValue) return null;
        const normalizedValue = statusValue.toUpperCase().trim();

        if (normalizedValue.includes('PROTOCOLADO')) {
            return 'status-protocolado';
        } 
        
        // Mapeia "Em Diligência" e "Encaminhado ao Juizado" para o status "PENDENTE"
        if (normalizedValue.includes('DILIGÊNCIA') ||
            normalizedValue.includes('JUIZADO') ||
            normalizedValue.includes('PENDENTE')
        ) {
            return 'status-pendente'; 
        } 
        
        if (normalizedValue.includes('ARQUIVADO')) {
            return 'status-arquivado';
        }
        return null;
    }


    /**
     * 1. FUNÇÕES DE COMUNICAÇÃO (GET/POST)
     */

    async function fetchData(action, method = 'GET', params = {}) {
        const url = new URL(WEBAPP_URL);
        url.searchParams.append('action', action);

        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        };

        if (method === 'GET') {
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        } else if (method === 'POST') {
            options.body = new URLSearchParams(params).toString();
        }

        try {
            const response = await fetch(url.toString(), options);
            if (!response.ok) {
                throw new Error(`Erro de rede: ${response.statusText}`);
            }
            return response.json();
        } catch (error) {
            console.error('Erro na comunicação com o App Script:', error);
            alert('Erro ao carregar ou salvar dados. Verifique a URL do Web App e o console.');
            return { status: 'error', message: error.message };
        }
    }

    async function loadTCO() {
        tabelaBody.innerHTML = '';
        msgCarregamento.style.display = 'block';

        const result = await fetchData('read');

        msgCarregamento.style.display = 'none';

        if (result.status === 'error') {
            console.error('Erro ao carregar TCO:', result.message);
            tabelaBody.innerHTML = `<tr><td colspan="${chavesTCO.length + 1}">Erro ao carregar dados: ${result.message}</td></tr>`;
            return;
        }

        // Armazena os dados brutos e renderiza a tabela com o filtro vazio
        dadosTCO = result;
        renderTable(dadosTCO);
        attachDropdownListeners(); // ANEXA LISTENERS DEPOIS DE RENDERIZAR
    }

    async function saveRow(rowElement, isNew) {
        rowElement.style.opacity = '0.5';

        const rowData = {};
        const rowId = rowElement.dataset.id;
        let success = false;
        let response;

        // 1. Coleta os dados de todas as células editáveis/dropdowns
        chavesTCO.forEach(chave => {
            const cell = rowElement.querySelector(`[data-key="${chave}"]`);
            if (cell) {
                const isDropdown = DROPDOWN_OPTIONS.hasOwnProperty(chave);
                if (isDropdown) {
                    // Para o dropdown, busca o valor do select
                    rowData[chave] = cell.querySelector('select').value;
                } else {
                    rowData[chave] = cell.textContent.trim();
                }
            }
        });

        // 2. Chama o App Script
        if (isNew) {
            // Ação de CRIAÇÃO
            response = await fetchData('create', 'POST', rowData);
            if (response.status === 'success') {
                rowElement.dataset.id = response.newId; // Atualiza o ID da linha com o novo ID
                success = true;
            }
        } else {
            // Ação de ATUALIZAÇÃO
            rowData['ID'] = rowId; // Adiciona o ID para a busca
            response = await fetchData('update', 'POST', rowData);
            if (response.status === 'success') {
                success = true;
            }
        }

        // 3. Feedback visual e recarregamento
        rowElement.style.opacity = '1';
        if (success) {
            alert(isNew ? 'Novo TCO criado com sucesso!' : 'TCO atualizado com sucesso!');
            rowElement.classList.remove('new-row-highlight');
            rowElement.classList.remove('editing');
            await loadTCO(); // Recarrega a tabela para garantir sincronia
        } else {
            alert(`Falha ao salvar: ${response.message}`);
            console.error('Erro de salvamento:', response.message);
        }
    }

    /**
     * 2. FUNÇÕES DE RENDERIZAÇÃO E EDIÇÃO
     */

    function createDropdown(key, currentValue) {
        const options = DROPDOWN_OPTIONS[key] || [];
        
        let selectHtml = `<select class="dropdown-select" data-key="${key}">`;
        
        let found = false;
        options.forEach(option => {
            if (option === currentValue) {
                found = true;
            }
            selectHtml += `<option value="${option}" ${option === currentValue ? 'selected' : ''}>${option}</option>`;
        });
        
        if (!found && currentValue) {
            selectHtml = `<option value="${currentValue}" selected>${currentValue}</option>` + selectHtml;
        }

        selectHtml += '</select>';
        return selectHtml;
    }
    
    /**
     * Adiciona listeners para mudar a cor da célula Movimentação ao selecionar
     */
    function attachDropdownListeners() {
        const movimentacaoCells = document.querySelectorAll('#tabela-tco td[data-key="Movimentação"]');
        
        movimentacaoCells.forEach(cell => {
            const select = cell.querySelector('select.dropdown-select');
            if (select) {
                select.addEventListener('change', function() {
                    const newValue = this.value;
                    // Remove todas as classes de status e aplica a nova
                    cell.classList.remove('status-protocolado', 'status-pendente', 'status-arquivado');
                    const newStatusClass = getStatusClass(newValue);
                    
                    // Adiciona a classe tag e a classe de cor
                    cell.classList.add('status-tag');
                    if (newStatusClass) {
                        cell.classList.add(newStatusClass);
                    }
                });
            }
        });
    }


    function renderTable(data) {
        tabelaBody.innerHTML = ''; // Limpa o corpo da tabela

        if (data.length === 0) {
            tabelaBody.innerHTML = `<tr><td colspan="${chavesTCO.length + 1}">Nenhum TCO encontrado.</td></tr>`;
            return;
        }

        data.forEach(item => {
            const row = tabelaBody.insertRow();
            row.dataset.id = item.ID || '';
            row.classList.add('editing'); 

            chavesTCO.forEach(chave => {
                const cell = row.insertCell();
                cell.dataset.key = chave;

                const isEditable = chavesEditaveis.includes(chave);
                const isDropdown = DROPDOWN_OPTIONS.hasOwnProperty(chave);
                
                let value = item[chave] || '';

                if (chave === 'Movimentação') { 
                    const statusClass = getStatusClass(value);
                    
                    // Adiciona a classe .status-tag para o visual de caixa colorida (obrigatório)
                    if (statusClass) {
                        cell.classList.add(statusClass);
                    }
                }
                
                if (chave === 'ID') {
                    cell.textContent = value;
                    cell.contentEditable = 'false';
                } else if (isDropdown) {
                    cell.innerHTML = createDropdown(chave, value);
                    cell.contentEditable = 'false'; 
                } else if (isEditable) {
                    cell.textContent = value;
                    cell.contentEditable = 'true';
                } else {
                    cell.textContent = value;
                    cell.contentEditable = 'false';
                }
            });

            // Coluna AÇÕES
            const actionCell = row.insertCell();
            actionCell.innerHTML = `
                <button class="btn-salvar-evento" onclick="handleSave(this)">Salvar</button>
                <button class="btn-deletar-evento" onclick="handleDelete(this)">Excluir</button>
            `;
        });
    }

    function handleSave(button) {
        const row = button.closest('tr');
        const isNew = !row.dataset.id || row.dataset.id.startsWith('new_');
        saveRow(row, isNew);
    }

    function handleDelete(button) {
        const row = button.closest('tr');
        const id = row.dataset.id;

        if (id && id.startsWith('new_')) {
            row.remove();
            return;
        }

        if (confirm(`Tem certeza que deseja EXCLUIR o TCO com ID ${id}?`)) {
            alert('A função de exclusão (DELETE) precisa ser implementada no Google Apps Script.');
        }
    }

    function addNewRow() {
        const tempId = 'new_' + Date.now();
        const row = tabelaBody.insertRow(0); // Insere no topo
        row.dataset.id = tempId;
        row.classList.add('new-row-highlight', 'editing');

        chavesTCO.forEach(chave => {
            const cell = row.insertCell();
            cell.dataset.key = chave;

            const isEditable = chavesEditaveis.includes(chave);
            const isDropdown = DROPDOWN_OPTIONS.hasOwnProperty(chave);

            let initialValue = '';

            if (chave === 'Movimentação') { 
                initialValue = DROPDOWN_OPTIONS[chave][0]; 
                const statusClass = getStatusClass(initialValue);
                
                // Adiciona a classe .status-tag para o visual de caixa colorida (obrigatório)
                if (statusClass) {
                    cell.classList.add(statusClass);
                }
            }


            if (chave === 'ID') {
                cell.textContent = '[NOVO TCO]'; 
                cell.contentEditable = 'false';
            } else if (isDropdown) {
                cell.innerHTML = createDropdown(chave, initialValue);
                cell.contentEditable = 'false';
            } else if (isEditable) {
                cell.textContent = initialValue;
                cell.contentEditable = 'true';
            } else {
                cell.textContent = initialValue;
                cell.contentEditable = 'false';
            }
        });

        // Coluna AÇÕES
        const actionCell = row.insertCell();
        actionCell.innerHTML = `
            <button class="btn-salvar-evento" onclick="handleSave(this)">Salvar</button>
            <button class="btn-deletar-evento" onclick="handleDelete(this)">Cancelar</button>
        `;

        row.scrollIntoView({ behavior: 'smooth', block: 'start' });
        attachDropdownListeners(); // ANEXA LISTENERS TAMBÉM AO ADICIONAR NOVA LINHA
    }
    
    /**
     * 3. FUNÇÕES DE FILTRAGEM
     */

    function aplicarFiltro() {
        const filtroTipo = document.getElementById('filtro-tipo').value;
        const filtroValor = document.getElementById('filtro-valor-text').value.toLowerCase().trim();
        const btnLimpar = document.getElementById('btn-limpar-filtro');

        if (!filtroTipo || !filtroValor) {
            renderTable(dadosTCO);
            btnLimpar.style.display = 'none';
            attachDropdownListeners();
            return;
        }
        
        const dadosFiltrados = dadosTCO.filter(item => {
            const valorCelula = (item[filtroTipo] || '').toString().toLowerCase();
            return valorCelula.includes(filtroValor);
        });

        renderTable(dadosFiltrados);
        btnLimpar.style.display = 'inline-block';
        attachDropdownListeners();
    }

    function limparFiltro() {
        document.getElementById('filtro-tipo').value = '';
        document.getElementById('filtro-valor-text').value = '';
        document.getElementById('btn-limpar-filtro').style.display = 'none';
        renderTable(dadosTCO);
        attachDropdownListeners();
    }
    
    // Função de Impressão (Implementação Simples)
    function imprimirTabela() {
        window.print();
    }


    /**
     * 4. FUNÇÕES DE SUPORTE (Relógio / Login)
     */
    
    // Função para formatar e exibir a data/hora
    function atualizarRelogio() {
        const agora = new Date();

        const opcoesData = { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' };
        const dataFormatada = agora.toLocaleDateString('pt-BR', opcoesData);

        const horaFormatada = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        document.getElementById('relogio').innerHTML = `${dataFormatada} <br> ${horaFormatada}`;
    }

    // Função de Login/Logout
    function checkLogin() {
        const graduacao = localStorage.getItem('userGraduacao');
        const nomeGuerra = localStorage.getItem('userNomeGuerra');
        const userInfoEl = document.getElementById('user-info');

        if (graduacao && nomeGuerra) {
            userInfoEl.innerHTML = `
            <p>Bem Vindo(a):</p>
            <p class="user-nome">${graduacao} ${nomeGuerra}</p>
        `;
        } else {
            alert('Sessão expirada ou não iniciada. Redirecionando para a tela de Login.');
            window.location.href = 'login.html';
        }
    }

    function logout() {
        localStorage.removeItem('userGraduacao');
        localStorage.removeItem('userNomeGuerra');
        alert('Logout realizado com sucesso!');
        window.location.href = 'login.html';
    }


    /**
     * 5. INICIALIZAÇÃO
     */

    document.addEventListener('DOMContentLoaded', function () {
        // Inicializa o Relógio
        atualizarRelogio();
        setInterval(atualizarRelogio, 1000);

        // Verifica Login
        checkLogin(); 
        
        // Carrega os dados do TCO
        loadTCO(); 

        // Anexa Listeners
        document.getElementById('btn-logout').addEventListener('click', logout);
        document.getElementById('btn-adicionar-cadastro').addEventListener('click', addNewRow);
        document.getElementById('btn-aplicar-filtro').addEventListener('click', aplicarFiltro);
        document.getElementById('btn-limpar-filtro').addEventListener('click', limparFiltro);
        
        const btnImprimir = document.getElementById('btn-imprimir');
        if (btnImprimir) {
            btnImprimir.addEventListener('click', imprimirTabela);
        }

        console.log("Sistema TCO inicializado. Lembre-se de atualizar a variável 'WEBAPP_URL' no script.");
    });
</script>
</html>