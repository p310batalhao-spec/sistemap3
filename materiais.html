<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento P3 - Materiais Apreendidos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="stylesmateriais.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <header>
        <div class="header-info-left">
            <img class="brasao" src="brasao.png" alt="brasão do 10º Batalhão">
            <div class="cabecalhotexto">
                <h1>SISTEMA DE GERENCIAMENTO P3</h1>
                <h3>10º BATALHÃO DE POLÍCIA MILITAR</h3>
            </div>
        </div>

        <div class="header-info-right">
            <div class="relogio" id="relogio"></div>
            <div class="exibirusuario" id="user-info"></div>
        </div>
    </header>

    <section class="pagecomplete">
        <nav class="navegacao">
            <a href="index.html">
                <img width="48" height="48" src="https://img.icons8.com/fluency-systems-regular/48/home--v1.png"
                    alt="home--v1" />
                <p>Home</p>
            </a><!--termina home-->
            <a href="dashboard.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/performance-macbook.png" alt="performance-macbook"/>
                <p>Dashboard</p>
            </a><!--termina dashboard-->
            <a href="cadastroocorrencias.html">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/add-file.png" alt="add-file" />
                <p>Cadastro de Ocorrências</p>
            </a><!--termina cadastroocorrencias-->
            <a href="materiais.html" class="active">
                <img width="50" height="50" src="https://img.icons8.com/ios/50/box--v1.png" alt="box--v1" />
                <p>Materiais Apreendidos</p>
            </a><!--termina materiais apreendidos-->
            <a href="eventos.html">
                <img width="32" height="32"
                    src="https://img.icons8.com/external-outlines-amoghdesign/32/external-dance-happy-new-year-outlines-amoghdesign.png"
                    alt="external-dance-happy-new-year-outlines-amoghdesign" />
                <p>Eventos</p>
            </a><!--termina eventos-->
            <a href="solucoesia.html">
                <img width="48" height="48" src="https://img.icons8.com/sf-regular/48/bot.png" alt="bot" />
                <p>Soluções IA</p>
            </a><!--termina solucoes ia-->
            <button id="btn-logout" class="btn-logout">
                <img width="48" height="48" src="https://img.icons8.com/material-outlined/48/exit.png" alt="Sair" />
                <p>Sair</p>
            </button><!--termina sair-->
        </nav><!--termina navegacao-->

        <main>

            <div class="totalcards">
                <div class="cardnumero">
                    <h4>Total Ano Anterior</h4>
                    <p id="total-ano-anterior">0</p>
                </div> <!-- FIM cardnumero -->
                <div class="cardnumero">
                    <h4>Total do Ano</h4>
                    <p id="total-ano-atual">0</p>
                </div><!-- FIM cardnumero -->
            </div><!-- FIM totalcards -->

            <div class="TabelaEventos">
                <h3>Cadastro e Gerenciamento de Materiais Apreendidos</h3>

                <div class="adicionar-cadastro-container">
                    <button id="btn-adicionar-cadastro">
                        <img width="20" height="20" src="https://img.icons8.com/ios-filled/50/plus--v1.png"
                            alt="Adicionar" />
                        Adicionar Novo Material
                    </button>
                    <p id="mensagem-carregamento">Carregando dados, aguarde...</p>
                </div> <!-- FIM adicionar-cadastro-container -->

                <div class="filtros-container">
                    <label for="filtro-tipo">Filtrar por:</label>
                    <select id="filtro-tipo">
                        <option value="">Selecione o campo</option>
                        <option value="N° DO BOU">N° BOU</option>
                        <option value="DATA">Data</option>
                        <option value="CATEGORIA">Categoria</option>
                        <option value="STATUS">Status</option>
                    </select>

                    <input type="text" id="filtro-valor-text" placeholder="Digite o valor...">
                    <button id="btn-aplicar-filtro">Aplicar Filtro</button>
                    <button id="btn-limpar-filtro" style="display: none;">Limpar Filtro</button>

                    <div class="actions-bar">
                        <button id="btn-imprimir" class="action-button primary-button">
                            <img width="24" height="24" src="https://img.icons8.com/material-outlined/24/print.png"
                                alt="Imprimir" />
                        </button>
                    </div>
                </div>

                <div class="tabela-container">
                    <table id="tabela-materiais">
                        <thead>
                            <tr>
                                <th>IDMaterial</th>
                                <th>N° DO BOU</th>
                                <th>DATA</th>
                                <th>CATEGORIA</th>
                                <th>DESCRIÇÃO</th>
                                <th>LOCAL DO DEPÓSITO</th>
                                <th>DATA DE DEPOSITO</th>
                                <th>ESAJ</th>
                                <th>STATUS</th>
                                <th>AÇÕES</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>


        </main>
    </section>

    <footer>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
    </footer>

    <script>
        let allMateriais = [];
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyftHcIS_0isNZsUsWrNBgOItkKeLMJbrhnpPz3zj4m0-5Vczkf2xDKrdpI-dMsI-9mQg/exec';

        // ORDEM DAS CHAVES (Sincronizada com o <thead>)
        const chavesMateriais = [
            'IDMaterial', 'N° DO BOU', 'DATA', 'CATEGORIA', 'DESCRIÇÃO',
            'LOCAL', 'DATA DE DEPOSITO', 'ESAJ', 'STATUS'
        ];
        const chavesEditaveis = chavesMateriais.filter(key => key !== 'IDMaterial');
        const STATUS_OPTIONS = ['PROTOCOLADO', 'PENDENTE', 'ARQUIVADO', 'DEVOLVIDO', 'EM TRÂNSITO'];

        /**
         * 1. CARREGAMENTO DE DADOS
         */
        async function fetchData() {
            const mensagem = document.getElementById('mensagem-carregamento');
            try {
                const response = await fetch(`${WEBAPP_URL}?action=read`);
                const data = await response.json();
                allMateriais = data;
                renderTable(allMateriais);
                loadTotalCounts(); // Chama a contagem dos cards
            } catch (error) {
                console.error("Erro:", error);
                mensagem.textContent = "Erro ao carregar dados.";
            }
        }

        /**
         * 2. RENDERIZAÇÃO DA TABELA (Padrão Imagem 1)
         */
        function renderTable(dataToRender) {
            const tbody = document.querySelector('#tabela-materiais tbody');
            const mensagem = document.getElementById('mensagem-carregamento');
            tbody.innerHTML = '';

            if (dataToRender && dataToRender.length) {
                mensagem.style.display = 'none';
                dataToRender.forEach(item => {
                    const row = tbody.insertRow();

                    // Coluna ID (Oculta ou visível conforme seu CSS)
                    row.insertCell().textContent = item.IDMaterial || '';

                    // Colunas Editáveis
                    chavesEditaveis.forEach(key => {
                        const cell = row.insertCell();
                        cell.dataset.campo = key;
                        if (key === 'STATUS') {
                            redrawStatusBadge(cell, item[key]);
                        } else {
                            cell.textContent = item[key] || '';
                            cell.setAttribute('contenteditable', 'true');
                        }
                    });

                    // Coluna Ações
                    const acoesCell = row.insertCell();
                    acoesCell.innerHTML = `
                        <button class="btn-salvar-evento" data-id="${item.IDMaterial}">Salvar</button>
                        <button class="btn-deletar-evento" data-id="${item.IDMaterial}">Excluir</button>
                    `;
                });
            }
        }

        /**
         * 3. FUNÇÕES DE STATUS (Badges)
         */
        function redrawStatusBadge(cell, statusValue) {
            const status = statusValue ? String(statusValue).toUpperCase() : 'PENDENTE';
            const statusClass = status.replace(/\s+/g, '').toLowerCase();
            cell.innerHTML = `<span class="status-badge status-${statusClass}">${status}</span>`;
            cell.addEventListener('click', () => createStatusSelect(cell, status), { once: true });
        }

        function createStatusSelect(cell, currentValue) {
            cell.innerHTML = '';
            const select = document.createElement('select');
            select.classList.add('status-select');
            STATUS_OPTIONS.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt; o.textContent = opt;
                if (opt === currentValue) o.selected = true;
                select.appendChild(o);
            });
            select.addEventListener('blur', () => redrawStatusBadge(cell, select.value));
            cell.appendChild(select);
            select.focus();
        }

        /**
         * 4. CONTAGEM DOS CARDS (Sincronizado com o ano)
         */
        async function loadTotalCounts() {
            const anoAtual = new Date().getFullYear();
            // Aqui você faria a chamada para a ação de contagem se existir no code.gs
            // Por enquanto, vamos filtrar os dados já carregados localmente:
            const countAtual = allMateriais.filter(item => item.DATA && item.DATA.includes(anoAtual)).length;
            const countAnterior = allMateriais.filter(item => item.DATA && item.DATA.includes(anoAtual - 1)).length;

            document.getElementById('total-ano-atual').textContent = countAtual;
            document.getElementById('total-ano-anterior').textContent = countAnterior;
        }

        /**
         * 5. INICIALIZAÇÃO E LOGIN
         */
        function checkLogin() {
            const graduacao = localStorage.getItem('userGraduacao');
            const nomeGuerra = localStorage.getItem('userNomeGuerra');
            if (graduacao && nomeGuerra) {
                document.getElementById('user-info').innerHTML = `
                    <p>Bem Vindo(a):</p>
                    <p class="user-nome">${graduacao} ${nomeGuerra}</p>
                `;
            } else {
                window.location.href = 'login.html';
            }
        }

        function atualizarRelogio() {
            const agora = new Date();
            document.getElementById('relogio').innerHTML = agora.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'long', year: 'numeric' }) +
                '<br>' + agora.toLocaleTimeString('pt-BR');
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            atualizarRelogio();
            setInterval(atualizarRelogio, 1000);
            fetchData();

            document.getElementById('btn-logout').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'login.html';
            });

            // Listener para salvar (Delegado)
            document.querySelector('#tabela-materiais tbody').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-salvar-evento')) {
                    const row = e.target.closest('tr');
                    saveData(row);
                }
            });
        });

        async function saveData(rowElement) {
            // Lógica de salvamento via POST enviando os dados da linha
            alert("Enviando dados para o servidor...");
            // Implementação do fetch(WEBAPP_URL, {method: 'POST'...}) aqui
        }
    </script>
</body>

</html>